# ğŸ—ï¸ Architecture et Flux de traitement

## Vue d'ensemble - Architecture Multi-Tenant

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   APPLICATION TIERCE (OAuth2 Client)             â”‚
â”‚  - Authentifie via Client Credentials (johodp.admin scope)       â”‚
â”‚  - CrÃ©e Clients, CustomConfigurations, Tenants, Users            â”‚
â”‚  - ReÃ§oit webhooks de vÃ©rification utilisateur                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    Client Credentials Flow
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               JOHODP IDENTITY PROVIDER (OAuth2/OIDC)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  IdentityServer (Duende)                                  â”‚  â”‚
â”‚  â”‚  - Authorization Server (OAuth2 + OIDC)                   â”‚  â”‚
â”‚  â”‚  - Endpoints: /connect/authorize, /connect/token         â”‚  â”‚
â”‚  â”‚  - CustomClientStore (agrÃ©gation dynamique)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Layer (Johodp.Api)                                   â”‚  â”‚
â”‚  â”‚  - AccountController (login, activate, forgot password)   â”‚  â”‚
â”‚  â”‚  - ClientsController (CRUD clients OAuth2)                â”‚  â”‚
â”‚  â”‚  - CustomConfigurationsController (branding/i18n)         â”‚  â”‚
â”‚  â”‚  - TenantsController (CRUD tenants)                       â”‚  â”‚
â”‚  â”‚  - UsersController (CRUD users)                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                   Authorization Code + PKCE
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APPLICATION SPA (End User)                    â”‚
â”‚  - Login via OAuth2 Authorization Code Flow + PKCE              â”‚
â”‚  - AccÃ¨s APIs avec access_token (Bearer)                        â”‚
â”‚  - Refresh token pour renouvellement session                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Architecture en Couches (Clean Architecture)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API LAYER (Johodp.Api)                      â”‚
â”‚  - Controllers (AccountController, UsersController, etc.)        â”‚
â”‚  - Middleware (CORS, JWT validation, exception handling)         â”‚
â”‚  - IdentityServer configuration (CustomClientStore)              â”‚
â”‚  - Health checks (database, IdentityServer)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         APPLICATION LAYER (Johodp.Application - CQRS)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Commands (Write operations)                             â”‚   â”‚
â”‚  â”‚  - RegisterUserCommand, CreateTenantCommand, etc.        â”‚   â”‚
â”‚  â”‚  - FluentValidation validators                           â”‚   â”‚
â”‚  â”‚  - Command handlers (business orchestration)             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Queries (Read operations)                               â”‚   â”‚
â”‚  â”‚  - GetUserByIdQuery, GetTenantQuery, etc.                â”‚   â”‚
â”‚  â”‚  - Query handlers (data retrieval)                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  DTOs & Contracts                                        â”‚   â”‚
â”‚  â”‚  - UserDto, TenantDto, ClientDto, CustomConfigurationDto â”‚   â”‚
â”‚  â”‚  - Request/Response models                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             DOMAIN LAYER (Johodp.Domain - DDD)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Aggregates (business logic & invariants)                â”‚   â”‚
â”‚  â”‚  - User (TenantId, Role, Scope, Status)                  â”‚   â”‚
â”‚  â”‚  - Client (ClientName, Scopes, AssociatedTenantIds)      â”‚   â”‚
â”‚  â”‚  - Tenant (CustomConfigurationId, CORS, RedirectURIs)    â”‚   â”‚
â”‚  â”‚  - CustomConfiguration (Branding, Languages)             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Value Objects (validation & immutability)               â”‚   â”‚
â”‚  â”‚  - Email, UserId, TenantId, ClientName, etc.             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Domain Events                                           â”‚   â”‚
â”‚  â”‚  - UserActivatedEvent, TenantCreatedEvent, etc.          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”¹â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Enumeration Classes (behavior-rich)                     â”‚   â”‚
â”‚  â”‚  - UserStatus (PendingActivation, Active, Suspended)     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        INFRASTRUCTURE LAYER (Johodp.Infrastructure)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Persistence (EF Core + PostgreSQL)                      â”‚   â”‚
â”‚  â”‚  - JohodpDbContext (users, clients, tenants, configs)    â”‚   â”‚
â”‚  â”‚  - Entity Configurations (Fluent API)                    â”‚   â”‚
â”‚  â”‚  - Repositories (User, Client, Tenant, CustomConfig)     â”‚   â”‚
â”‚  â”‚  - UnitOfWork pattern                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  IdentityServer Integration                              â”‚   â”‚
â”‚  â”‚  - CustomClientStore (dynamic client aggregation)        â”‚   â”‚
â”‚  â”‚  - CustomProfileService (user claims)                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  External Services                                       â”‚   â”‚
â”‚  â”‚  - EmailService (SMTP)                                   â”‚   â”‚
â”‚  â”‚  - WebhookService (user verification callbacks)          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATABASE (PostgreSQL)                         â”‚
â”‚  - users (id, email, tenant_id, role, scope, status)            â”‚
â”‚  - clients (id, client_name, scopes, associated_tenant_ids)     â”‚
â”‚  - tenants (id, name, custom_config_id, cors, redirect_urls)    â”‚
â”‚  - custom_configurations (id, name, colors, logo, languages)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ModÃ¨le de DonnÃ©es Multi-Tenant

### Relations entre Aggregates

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CustomConfiguration                        â”‚
â”‚  - CustomConfigurationId (PK)                               â”‚
â”‚  - Name (unique)                                            â”‚
â”‚  - Branding (colors, logo, CSS)                             â”‚
â”‚  - Languages (defaultLanguage, supportedLanguages)          â”‚
â”‚  - IsActive                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ 1:N (many tenants can share one config)
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Tenant                                  â”‚
â”‚  - TenantId (PK)                                            â”‚
â”‚  - Name (unique, URL-safe)                                  â”‚
â”‚  - CustomConfigurationId (FK - required)                    â”‚
â”‚  - AllowedReturnUrls (OAuth2 redirect URIs)                 â”‚
â”‚  - AllowedCorsOrigins (browser CORS origins)                â”‚
â”‚  - NotificationUrl (webhook for user verification)          â”‚
â”‚  - Localization (timezone, currency, formats)               â”‚
â”‚  - IsActive                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚              â”‚
         â”‚ N:1          â”‚ N:1          â”‚ N:1
         â”‚              â”‚              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User        â”‚  â”‚   Client   â”‚  â”‚  Webhook Call   â”‚
â”‚  - UserId      â”‚  â”‚  - ClientIdâ”‚  â”‚  (ephemeral)    â”‚
â”‚  - Email       â”‚  â”‚  - Name    â”‚  â”‚                 â”‚
â”‚  - TenantId(FK)â”‚  â”‚  - Assoc   â”‚  â”‚                 â”‚
â”‚  - Role        â”‚  â”‚    TenantIdsâ”‚  â”‚                 â”‚
â”‚  - Scope       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  - Status      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend:
- FK: Foreign Key
- PK: Primary Key
- 1:N: One-to-Many relationship
- N:1: Many-to-One relationship
```

### Isolation Multi-Tenant

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ISOLATION PAR TENANT (TenantId)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  User Table:                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ id | email           | tenant_id | role | scope     â”‚   â”‚
â”‚  â”‚â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚
â”‚  â”‚ 01 | john@acme.com   | tenant-A  | user | default   â”‚   â”‚
â”‚  â”‚ 02 | jane@acme.com   | tenant-A  | admin| default   â”‚   â”‚
â”‚  â”‚ 03 | bob@corp.com    | tenant-B  | user | premium   â”‚   â”‚
â”‚  â”‚ 04 | john@acme.com   | tenant-B  | user | default   â”‚   â”‚ <- MÃªme email, tenant diffÃ©rent = OK
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  Composite Unique Constraint: (email, tenant_id)            â”‚
â”‚  - Un email peut exister dans plusieurs tenants             â”‚
â”‚  - Un email est unique au sein d'un tenant                  â”‚
â”‚                                                              â”‚
â”‚  Recherche utilisateur:                                      â”‚
â”‚  FindByEmailAndTenantAsync(email, tenantId)                 â”‚
â”‚  WHERE email = @email AND tenant_id = @tenantId             â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Branding PartagÃ© (CustomConfiguration)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CustomConfiguration INDÃ‰PENDANTE & PARTAGEABLE       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  CustomConfiguration Table:                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ id    | name          | primary_color | logo_url     â”‚   â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚
â”‚  â”‚ cfg-1 | acme-branding | #FF0000       | logo-red.png â”‚   â”‚
â”‚  â”‚ cfg-2 | corp-branding | #0000FF       | logo-blue.pngâ”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  Tenant Table:                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ id       | name       | custom_config_id | client_id â”‚   â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚
â”‚  â”‚ tenant-A | acme-us    | cfg-1            | client-X  â”‚   â”‚
â”‚  â”‚ tenant-B | acme-fr    | cfg-1            | client-X  â”‚ <- Partage cfg-1
â”‚  â”‚ tenant-C | corp-main  | cfg-2            | client-Y  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  Avantages:                                                  â”‚
â”‚  âœ… Branding cohÃ©rent sur plusieurs tenants                 â”‚
â”‚  âœ… Modification centralisÃ©e (1 update â†’ N tenants)         â”‚
â”‚  âœ… RÃ©utilisable cross-client (non liÃ© Ã  un client)         â”‚
â”‚  âœ… Langues partagÃ©es entre tenants                         â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Flux de CrÃ©ation d'un Utilisateur (Onboarding avec Webhook)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FLUX ONBOARDING AVEC VALIDATION TIERCE             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. User â†’ SPA: Clic "CrÃ©er un compte"
   â”‚
2. SPA â†’ Johodp: Redirect /account/onboarding?acr_values=tenant:acme-corp
   â”‚
3. Johodp: Afficher formulaire (email, firstName, lastName)
   â”‚        + Branding du tenant (via CustomConfiguration)
   â”‚
4. User â†’ Johodp: Submit formulaire
   â”‚
5. Johodp â†’ Validation:
   â”‚  - VÃ©rifier unicitÃ© (email, tenantId)
   â”‚  - Valider format email
   â”‚
6. Johodp â†’ App Tierce: POST webhook (NotificationUrl du tenant)
   â”‚                      Headers: X-Johodp-Signature (HMAC)
   â”‚                      Body: { email, firstName, lastName, tenantId }
   â”‚
7. App Tierce â†’ Validation mÃ©tier:
   â”‚  - VÃ©rifier signature HMAC
   â”‚  - Appliquer rÃ¨gles business (contrats, client existant, etc.)
   â”‚
8a. Si VALIDE:
   â”‚  App Tierce â†’ Johodp: POST /api/users/register
   â”‚                        Bearer: access_token (johodp.admin scope)
   â”‚                        Body: { email, firstName, lastName, tenantId, role, scope, createAsPending: true }
   â”‚
   â”‚  Johodp â†’ UserAggregate: User.CreatePending()
   â”‚  â”‚  - Status = PendingActivation
   â”‚  â”‚  - TenantId, Role, Scope
   â”‚  â”‚  - PasswordHash = null
   â”‚  â”‚  - Event: UserPendingActivationEvent
   â”‚
   â”‚  Johodp â†’ Database: INSERT INTO users
   â”‚
   â”‚  Johodp â†’ Email: Envoyer lien d'activation
   â”‚  â”‚  /account/activate?token=xxx&userId=yyy&tenant=acme-corp
   â”‚
   â”‚  Johodp â†’ User: Afficher "Email envoyÃ©, vÃ©rifiez votre boÃ®te"
   â”‚
8b. Si INVALIDE ou TIMEOUT (5 min):
   â”‚  Johodp â†’ User: "Validation en cours, veuillez rÃ©essayer plus tard"
   â”‚
9. User â†’ Email: Clic lien activation
   â”‚
10. Johodp: /account/activate?token=xxx&userId=yyy&tenant=acme-corp
    â”‚  - Afficher formulaire mot de passe
    â”‚
11. User â†’ Johodp: Submit nouveau mot de passe
    â”‚
12. Johodp â†’ UserManager: VerifyUserTokenAsync(token)
    â”‚
13. Johodp â†’ UserAggregate: user.SetPasswordHash(hash)
    â”‚                         user.Activate()
    â”‚  - Status = Active
    â”‚  - ActivatedAt = Now
    â”‚  - Event: UserActivatedEvent
    â”‚
14. Johodp â†’ Database: UPDATE users SET status = 1, password_hash = xxx
    â”‚
15. Johodp â†’ User: Connexion automatique + redirection
```

## IntÃ©gration IdentityServer & CustomClientStore

### OAuth2/OIDC avec AgrÃ©gation Dynamique

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         OAuth2/OIDC Authorization Code Flow          â”‚
â”‚                  avec PKCE (Proof Key)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
                          â”‚                          â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
            â”‚   SPA/Client Application   â”‚          â”‚
            â”‚  1. GÃ©nÃ©rer code_verifier  â”‚          â”‚
            â”‚  2. Calculer code_challengeâ”‚          â”‚
            â”‚  3. /connect/authorize     â”‚          â”‚
            â”‚     + acr_values=tenant:X  â”‚          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                          â”‚                          â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
     â”‚    IdentityServer (Duende)        â”‚          â”‚
     â”‚  - ReÃ§oit requÃªte OAuth2          â”‚          â”‚
     â”‚  - Appelle CustomClientStore      â”‚          â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                          â”‚                          â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚    CustomClientStore.FindClientByIdAsync()         â”‚
     â”‚  1. Query Client depuis DB (par ClientName)        â”‚
     â”‚  2. Query Tenants associÃ©s (AssociatedTenantIds)   â”‚
     â”‚  3. AgrÃ©ger RedirectURIs:                          â”‚
     â”‚     - tenant-A.AllowedReturnUrls                   â”‚
     â”‚     - tenant-B.AllowedReturnUrls                   â”‚
     â”‚     - Distinct() pour dÃ©dupliquer                  â”‚
     â”‚  4. AgrÃ©ger CorsOrigins:                           â”‚
     â”‚     - tenant-A.AllowedCorsOrigins                  â”‚
     â”‚     - tenant-B.AllowedCorsOrigins                  â”‚
     â”‚     - Distinct() pour dÃ©dupliquer                  â”‚
     â”‚  5. Retourner Duende.IdentityServer.Models.Client  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  IdentityServer valide:           â”‚
     â”‚  - redirect_uri dans la liste     â”‚
     â”‚  - CORS origin autorisÃ©           â”‚
     â”‚  - PKCE code_challenge            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  User: Login (email + password)   â”‚
     â”‚  - FindByEmailAndTenantAsync()    â”‚
     â”‚  - CheckPasswordAsync()           â”‚
     â”‚  - VÃ©rifier user.TenantId match   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  IdentityServer gÃ©nÃ¨re:           â”‚
     â”‚  - authorization_code             â”‚
     â”‚  - Redirect vers SPA callback     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  SPA Ã©change code contre tokens:  â”‚
     â”‚  POST /connect/token              â”‚
     â”‚  - code + code_verifier (PKCE)    â”‚
     â”‚  - client_id                      â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  IdentityServer retourne:         â”‚
     â”‚  - access_token (JWT, 1h)         â”‚
     â”‚  - id_token (user claims)         â”‚
     â”‚  - refresh_token (15 jours)       â”‚
     â”‚                                   â”‚
     â”‚  Claims dans id_token:            â”‚
     â”‚  - sub: UserId                    â”‚
     â”‚  - email: user@example.com        â”‚
     â”‚  - tenant_id: acme-corp           â”‚
     â”‚  - tenant_role: user/admin        â”‚
     â”‚  - tenant_scope: default/premium  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   SPA stocke tokens        â”‚
            â”‚  - localStorage/sessionStorage â”‚
            â”‚  - Appelle APIs avec Bearer â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### RÃ¨gles de VisibilitÃ© Client

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           CLIENT VISIBLE DANS IDENTITYSERVER ?               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  âœ… Client VISIBLE si:                                       â”‚
â”‚     1. Client.AssociatedTenantIds.Count > 0                 â”‚
â”‚     2. Tenants.AllowedReturnUrls.Count > 0                  â”‚
â”‚                                                              â”‚
â”‚  âŒ Client INVISIBLE si:                                     â”‚
â”‚     1. Client crÃ©Ã© mais aucun tenant associÃ©                â”‚
â”‚     2. Tenants associÃ©s mais sans redirect URIs             â”‚
â”‚     â†’ CustomClientStore.FindClientByIdAsync() â†’ null        â”‚
â”‚     â†’ OAuth2 error: unknown_client                          â”‚
â”‚                                                              â”‚
â”‚  Workflow de crÃ©ation:                                       â”‚
â”‚  1. POST /api/clients â†’ Client crÃ©Ã© (pas de tenants)        â”‚
â”‚     â†’ Client INVISIBLE pour IdentityServer                  â”‚
â”‚                                                              â”‚
â”‚  2. POST /api/custom-configurations â†’ Config crÃ©Ã©e          â”‚
â”‚     â†’ Branding & langues dÃ©finis                            â”‚
â”‚                                                              â”‚
â”‚  3. POST /api/tenants â†’ Tenant crÃ©Ã©                         â”‚
â”‚     - ClientName (FK)                                       â”‚
â”‚     - CustomConfigurationId (FK - required)                 â”‚
â”‚     - AllowedReturnUrls (OAuth2 redirect URIs)              â”‚
â”‚     - AllowedCorsOrigins (browser CORS)                     â”‚
â”‚     â†’ Client.AssociatedTenantIds.Add(tenantId)              â”‚
â”‚     â†’ Client devient VISIBLE pour IdentityServer            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Pattern CQRS - Commandes vs RequÃªtes

### Architecture CQRS avec Mini Mediator

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WRITE SIDE (Commands)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Controller â†’ Command â†’ Handler â†’ Aggregate                 â”‚
â”‚                                                              â”‚
â”‚  Exemple: RegisterUserCommand                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 1. UsersController.Register()                      â”‚     â”‚
â”‚  â”‚    - ReÃ§oit RegisterUserRequest                    â”‚     â”‚
â”‚  â”‚    - CrÃ©e RegisterUserCommand                      â”‚     â”‚
â”‚  â”‚    - Envoie Ã  MediatR                              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                       â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 2. RegisterUserCommandValidator                    â”‚     â”‚
â”‚  â”‚    - FluentValidation rules                        â”‚     â”‚
â”‚  â”‚    - Email format, required fields                 â”‚     â”‚
â”‚  â”‚    - TenantId, Role, Scope obligatoires            â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                       â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 3. RegisterUserCommandHandler                      â”‚     â”‚
â”‚  â”‚    - VÃ©rifier unicitÃ© (email, tenantId)            â”‚     â”‚
â”‚  â”‚    - CrÃ©er User.CreatePending()                    â”‚     â”‚
â”‚  â”‚    - Repository.AddAsync(user)                     â”‚     â”‚
â”‚  â”‚    - UnitOfWork.SaveChangesAsync()                 â”‚     â”‚
â”‚  â”‚    - Return RegisterUserResponse                   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                       â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 4. User Aggregate (Domain)                         â”‚     â”‚
â”‚  â”‚    - Business logic & invariants                   â”‚     â”‚
â”‚  â”‚    - Status = PendingActivation                    â”‚     â”‚
â”‚  â”‚    - DomainEvent: UserPendingActivationEvent       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                       â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 5. UnitOfWork.SaveChangesAsync()                   â”‚     â”‚
â”‚  â”‚    - EF Core DbContext.SaveChangesAsync()          â”‚     â”‚
â”‚  â”‚    - Transaction management                        â”‚     â”‚
â”‚  â”‚    - Publish domain events (if any)                â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     READ SIDE (Queries)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Controller â†’ Query â†’ Handler â†’ Repository â†’ DTO            â”‚
â”‚                                                              â”‚
â”‚  Exemple: GetUserByIdQuery                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 1. UsersController.GetUser(userId)                 â”‚     â”‚
â”‚  â”‚    - CrÃ©e GetUserByIdQuery                         â”‚     â”‚
â”‚  â”‚    - Envoie Ã  MediatR                              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                       â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 2. GetUserByIdQueryHandler                         â”‚     â”‚
â”‚  â”‚    - Repository.GetByIdAsync(userId)               â”‚     â”‚
â”‚  â”‚    - Map to UserDto                                â”‚     â”‚
â”‚  â”‚    - Return UserDto                                â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                       â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 3. UserRepository                                  â”‚     â”‚
â”‚  â”‚    - DbContext.Users.FirstOrDefaultAsync()         â”‚     â”‚
â”‚  â”‚    - No business logic                             â”‚     â”‚
â”‚  â”‚    - Simple data retrieval                         â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                       â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 4. Mapper (Manual or AutoMapper)                   â”‚     â”‚
â”‚  â”‚    - User entity â†’ UserDto                         â”‚     â”‚
â”‚  â”‚    - Flatten complex objects                       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                       â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 5. Return UserDto to client                        â”‚     â”‚
â”‚  â”‚    - Status, Email, TenantId, Role, Scope          â”‚     â”‚
â”‚  â”‚    - No domain objects exposed                     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Avantages CQRS

âœ… **SÃ©paration responsabilitÃ©s** - Write != Read logic
âœ… **Performance** - Optimisation indÃ©pendante read/write
âœ… **ScalabilitÃ©** - Read replicas, write master
âœ… **Ã‰volutivitÃ©** - Ajouter queries sans toucher commands
âœ… **TestabilitÃ©** - Tests isolÃ©s write vs read
âœ… **SimplicitÃ© queries** - Pas de business logic dans les reads

## Gestion CORS et SÃ©curitÃ©

### Architecture CORS (Migration Client â†’ Tenant)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Client Aggregate                      â”‚
â”‚  - ClientId, ClientName                                  â”‚
â”‚  - AllowedScopes (openid, profile, email, api)          â”‚
â”‚  - RequireConsent, RequirePkce                          â”‚
â”‚  - AssociatedTenantIds (List<TenantId>)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ 1:N (via AssociatedTenantIds)
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Tenant Aggregate                      â”‚
â”‚  - TenantId, Name, DisplayName                          â”‚
â”‚  - CustomConfigurationId (FK - required)                â”‚
â”‚  - AllowedReturnUrls (OAuth2 redirect URIs)             â”‚
â”‚  - AllowedCorsOrigins (Liste des origines CORS)         â”‚
â”‚  - NotificationUrl (webhook user verification)          â”‚
â”‚  - Localization (timezone, currency, formats)           â”‚
â”‚  - IsActive                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ AgrÃ©gation dynamique dans CustomClientStore
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CustomClientStore (IdentityServer)         â”‚
â”‚  MapToIdentityServerClient(client, tenants):            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ var corsOrigins = tenants                        â”‚   â”‚
â”‚  â”‚     .SelectMany(t => t.AllowedCorsOrigins)       â”‚   â”‚
â”‚  â”‚     .Distinct()                                  â”‚   â”‚
â”‚  â”‚     .ToList();                                   â”‚   â”‚
â”‚  â”‚                                                  â”‚   â”‚
â”‚  â”‚ var redirectUris = tenants                       â”‚   â”‚
â”‚  â”‚     .SelectMany(t => t.AllowedReturnUrls)        â”‚   â”‚
â”‚  â”‚     .Distinct()                                  â”‚   â”‚
â”‚  â”‚     .ToList();                                   â”‚   â”‚
â”‚  â”‚                                                  â”‚   â”‚
â”‚  â”‚ return new Duende.Client {                       â”‚   â”‚
â”‚  â”‚     ClientId = client.ClientName,                â”‚   â”‚
â”‚  â”‚     AllowedCorsOrigins = corsOrigins,            â”‚   â”‚
â”‚  â”‚     RedirectUris = redirectUris,                 â”‚   â”‚
â”‚  â”‚     RequirePkce = true                           â”‚   â”‚
â”‚  â”‚ };                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Pourquoi CORS est gÃ©rÃ© au niveau Tenant ?

âœ… **CohÃ©rence architecturale** - AllowedReturnUrls et AllowedCorsOrigins au mÃªme endroit (Tenant)
âœ… **Multi-tenant flexible** - Chaque tenant peut avoir ses propres origines CORS
âœ… **Isolation tenant** - CORS origins isolÃ©s par tenant, pas partagÃ©s entre tous les tenants d'un client
âœ… **HÃ©ritage client** - Un client peut hÃ©riter des CORS de plusieurs tenants (agrÃ©gation)
âœ… **MaintenabilitÃ©** - Configuration centralisÃ©e par tenant, modification locale vs globale
âœ… **Migration sans breaking change** - Les clients existants continuent de fonctionner via agrÃ©gation

### âš ï¸ IMPORTANT: Limites de sÃ©curitÃ© CORS

**CORS ne protÃ¨ge QUE les navigateurs web !**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CORS = Protection NAVIGATEUR uniquement       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚  âœ… ProtÃ¨ge:                                          â”‚
â”‚     - RequÃªtes depuis un navigateur web               â”‚
â”‚     - JavaScript (fetch, XMLHttpRequest, axios)       â”‚
â”‚     - Applications SPA (React, Angular, Vue)          â”‚
â”‚     - Scripts dans une page HTML                      â”‚
â”‚                                                       â”‚
â”‚  âŒ NE protÃ¨ge PAS:                                   â”‚
â”‚     - RequÃªtes curl / wget / Postman                  â”‚
â”‚     - Applications serveur (Node.js, C#, Python)      â”‚
â”‚     - Applications mobile natives (iOS, Android)      â”‚
â”‚     - Scripts backend / API-to-API calls              â”‚
â”‚     - Attaques CSRF (nÃ©cessite tokens anti-CSRF)      â”‚
â”‚                                                       â”‚
â”‚  âš ï¸ CORS est une COMMODITÃ‰ UX, PAS une SÃ‰CURITÃ‰      â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Exemple de contournement CORS

```bash
# âŒ BLOQUÃ‰ dans un navigateur (Origin: http://evil.com)
fetch('https://api.johodp.com/connect/token', {
  method: 'POST',
  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
  body: 'grant_type=client_credentials&client_id=xyz&client_secret=abc'
})
// ERROR: CORS policy: No 'Access-Control-Allow-Origin' header is present

# âœ… FONCTIONNE avec curl (pas de vÃ©rification CORS)
curl -X POST https://api.johodp.com/connect/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=client_credentials&client_id=xyz&client_secret=abc"
# SUCCESS: Retourne les tokens sans vÃ©rification d'origine

# âœ… FONCTIONNE avec Python requests (pas de vÃ©rification CORS)
import requests
response = requests.post('https://api.johodp.com/connect/token',
  data={'grant_type': 'client_credentials', 'client_id': 'xyz', 'client_secret': 'abc'})
# SUCCESS: CORS ne s'applique pas aux clients non-browser
```

### SÃ©curitÃ© rÃ©elle : Defense in Depth

**CORS est une COMMODITÃ‰, pas une SÃ‰CURITÃ‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Protection en couches (Defense in Depth)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. CORS (navigateur)       â†’ CommoditÃ© UX               â”‚
â”‚    - EmpÃªche requÃªtes cross-origin depuis navigateurs   â”‚
â”‚    - Ne remplace PAS l'authentification                 â”‚
â”‚                                                          â”‚
â”‚ 2. Authentication (OAuth2) â†’ Qui Ãªtes-vous ?            â”‚
â”‚    - Client Credentials (machine-to-machine)            â”‚
â”‚    - Authorization Code + PKCE (users)                  â”‚
â”‚    - Tokens JWT signÃ©s avec rotation des clÃ©s           â”‚
â”‚                                                          â”‚
â”‚ 3. Authorization (Claims)  â†’ Que pouvez-vous faire ?    â”‚
â”‚    - Scopes: openid, profile, email, johodp.admin       â”‚
â”‚    - Roles: user, admin                                 â”‚
â”‚    - Policy-based access control                        â”‚
â”‚                                                          â”‚
â”‚ 4. Rate Limiting           â†’ Limite abus                â”‚
â”‚    - Par IP: 100 req/min                                â”‚
â”‚    - Par access token: 1000 req/min                     â”‚
â”‚    - Protection DDoS                                    â”‚
â”‚                                                          â”‚
â”‚ 5. Client Authentication   â†’ Identification client      â”‚
â”‚    - ClientId + ClientSecret (confidential clients)     â”‚
â”‚    - PKCE (public clients / SPAs)                       â”‚
â”‚    - Mutual TLS (optionnel, haute sÃ©curitÃ©)             â”‚
â”‚                                                          â”‚
â”‚ 6. IP Whitelist (optionnel)â†’ Restriction gÃ©ographique  â”‚
â”‚    - Par tenant ou par client                           â”‚
â”‚    - Utile pour APIs internes/partenaires               â”‚
â”‚                                                          â”‚
â”‚ 7. Audit Logging           â†’ TraÃ§abilitÃ©                â”‚
â”‚    - Qui a fait quoi, quand, depuis oÃ¹                  â”‚
â”‚    - CorrÃ©lation requestId pour debugging               â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Configuration CORS dans Johodp

```csharp
// Infrastructure/IdentityServer/CustomClientStore.cs
public Duende.IdentityServer.Models.Client MapToIdentityServerClient(
    Client client, 
    IEnumerable<Tenant> tenants)
{
    // AgrÃ©gation dynamique des CORS origins depuis les tenants
    var corsOrigins = tenants
        .SelectMany(t => t.AllowedCorsOrigins)
        .Distinct()
        .ToList();

    // AgrÃ©gation dynamique des redirect URIs depuis les tenants
    var redirectUris = tenants
        .SelectMany(t => t.AllowedReturnUrls)
        .Distinct()
        .ToList();

    // Si aucun tenant ou aucune redirect URI â†’ client invisible
    if (!tenants.Any() || !redirectUris.Any())
        return null; // IdentityServer rejette la requÃªte OAuth2

    return new Duende.IdentityServer.Models.Client
    {
        ClientId = client.ClientName.Value,
        ClientName = client.ClientName.Value,
        
        // âš ï¸ CORS protÃ¨ge UNIQUEMENT les navigateurs
        AllowedCorsOrigins = corsOrigins,
        
        // OAuth2 configuration
        RedirectUris = redirectUris,
        PostLogoutRedirectUris = redirectUris, // MÃªme URLs pour logout
        AllowedScopes = client.AllowedScopes.ToList(),
        
        // SÃ©curitÃ© OAuth2
        RequireClientSecret = client.RequireClientSecret,
        RequirePkce = client.RequirePkce, // Obligatoire pour SPAs
        RequireConsent = client.RequireConsent,
        
        // Token lifetimes
        AccessTokenLifetime = 3600, // 1 heure
        RefreshTokenLifetime = 1296000, // 15 jours
        AbsoluteRefreshTokenLifetime = 1296000,
        SlidingRefreshTokenLifetime = 1296000,
        RefreshTokenUsage = TokenUsage.OneTimeOnly, // One-time use
        
        AllowOfflineAccess = true // Refresh tokens
    };
}
```

### Validation des CORS Origins (Domain Layer)

```csharp
// Domain/Tenants/Aggregates/Tenant.cs
public void AddAllowedCorsOrigin(string origin)
{
    if (string.IsNullOrWhiteSpace(origin))
        throw new ArgumentException("CORS origin cannot be empty");

    // Validation: URI absolue uniquement
    if (!Uri.TryCreate(origin, UriKind.Absolute, out var uri))
        throw new ArgumentException($"Invalid CORS origin format: {origin}");

    // Validation: AutoritÃ© uniquement (pas de path/query)
    // âœ… https://app.acme.com
    // âŒ https://app.acme.com/callback
    if (!string.IsNullOrEmpty(uri.PathAndQuery) && uri.PathAndQuery != "/")
        throw new ArgumentException(
            $"CORS origin must be authority only (no path): {origin}");

    // Normalisation: https://example.com (pas de trailing slash)
    var normalizedOrigin = $"{uri.Scheme}://{uri.Authority}";
    
    if (!_allowedCorsOrigins.Contains(normalizedOrigin))
        _allowedCorsOrigins.Add(normalizedOrigin);
}
```

### Configuration CORS Multi-Tenant

**Structure actuelle**
- CORS configurÃ© au niveau Tenant (pas au niveau Client)
- AgrÃ©gation dynamique dans CustomClientStore pour IdentityServer
- Stockage en JSONB dans PostgreSQL

## Webhook de VÃ©rification Utilisateur (Onboarding)

Le webhook d'onboarding permet la **validation mÃ©tier externe** avant la crÃ©ation effective de l'utilisateur (UC-04 / US-4.2). Il complÃ¨te le flux de formulaire cÃ´tÃ© Johodp en dÃ©clenchant un appel sortant vers l'application tierce.

### RÃ´le dans le Flux Onboarding

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        WEBHOOK FLOW (User Verification Callback)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. User â†’ Johodp: Submit /account/onboarding
   - Email, FirstName, LastName
   - acr_values=tenant:acme-corp
   â”‚
2. Johodp â†’ Validation interne:
   - VÃ©rifier unicitÃ© (email, tenantId)
   - Valider format email
   - Tenant actif?
   â”‚
3. Johodp â†’ Application Tierce: POST webhook
   â”‚  URL: tenant.NotificationUrl (ex: https://api.acme.com/webhooks/johodp/verify-user)
   â”‚  
   â”‚  Headers:
   â”‚  - Content-Type: application/json
   â”‚  - Authorization: Bearer <access_token> (OAuth2 client credentials)
   â”‚  - X-Johodp-Request-Id: uuid (correlation tracking)
   â”‚  
   â”‚  Body:
   â”‚  {
   â”‚    "requestId": "uuid",
   â”‚    "tenantId": "acme-corp",
   â”‚    "tenantUrl": "https://acme-corp.example.com",
   â”‚    "email": "user@example.com",
   â”‚    "firstName": "John",
   â”‚    "lastName": "Doe",
   â”‚    "timestamp": "2025-12-03T10:30:00Z"
   â”‚  }
   â”‚
4. Application Tierce â†’ Validation mÃ©tier:
   â”‚  - VÃ©rifier access_token (OAuth2 via Identity Server tiers)
   â”‚  - Valider scopes/claims du token
   â”‚  - RÃ¨gles business:
   â”‚    * Email correspond Ã  un contrat actif?
   â”‚    * Client existant dans CRM?
   â”‚    * Domaine email autorisÃ©?
   â”‚    * Quota utilisateurs non atteint?
   â”‚
5a. Si ACCEPTÃ‰:
   â”‚  Application Tierce â†’ Johodp API: POST /api/users/register
   â”‚  â”‚  Authorization: Bearer <access_token> (johodp.admin scope)
   â”‚  â”‚  
   â”‚  â”‚  Body:
   â”‚  â”‚  {
   â”‚  â”‚    "email": "user@example.com",
   â”‚  â”‚    "firstName": "John",
   â”‚  â”‚    "lastName": "Doe",
   â”‚  â”‚    "tenantId": "acme-corp",
   â”‚  â”‚    "role": "user",
   â”‚  â”‚    "scope": "default",
   â”‚  â”‚    "createAsPending": true
   â”‚  â”‚  }
   â”‚  â”‚
   â”‚  Johodp: CrÃ©er User (Status = PendingActivation)
   â”‚  Johodp: GÃ©nÃ©rer token activation
   â”‚  Johodp: Envoyer email avec lien /account/activate
   â”‚  Johodp â†’ User: "Email envoyÃ©, vÃ©rifiez votre boÃ®te"
   â”‚
5b. Si REFUSÃ‰ ou TIMEOUT (5 min):
   â”‚  Application Tierce: Ne rien faire (pas d'appel API)
   â”‚  Johodp â†’ User: "Validation en cours, rÃ©essayez plus tard"
   â”‚  Johodp: Logger timeout/rejet pour audit
```

### SÃ©curitÃ© Webhook

```csharp
// Johodp - Obtenir access token pour appeler webhook
public async Task<string> GetAccessTokenForWebhook(Tenant tenant)
{
    // Configuration OAuth2 Client Credentials
    var clientId = _configuration["Webhook:ClientId"];
    var clientSecret = _configuration["Webhook:ClientSecret"];
    var tokenEndpoint = _configuration["Webhook:TokenEndpoint"];
    
    var request = new HttpRequestMessage(HttpMethod.Post, tokenEndpoint);
    request.Content = new FormUrlEncodedContent(new[]
    {
        new KeyValuePair<string, string>("grant_type", "client_credentials"),
        new KeyValuePair<string, string>("client_id", clientId),
        new KeyValuePair<string, string>("client_secret", clientSecret),
        new KeyValuePair<string, string>("scope", "webhook.receive")
    });
    
    var response = await _httpClient.SendAsync(request);
    response.EnsureSuccessStatusCode();
    
    var tokenResponse = await response.Content.ReadFromJsonAsync<TokenResponse>();
    return tokenResponse.AccessToken;
}

// Johodp - Envoyer webhook avec token OAuth2
public async Task<bool> SendWebhookAsync(Tenant tenant, WebhookPayload payload)
{
    var accessToken = await GetAccessTokenForWebhook(tenant);
    
    var request = new HttpRequestMessage(HttpMethod.Post, tenant.NotificationUrl);
    request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);
    request.Headers.Add("X-Johodp-Request-Id", payload.RequestId);
    request.Content = new StringContent(
        JsonSerializer.Serialize(payload), 
        Encoding.UTF8, 
        "application/json"
    );
    
    try
    {
        var response = await _httpClient.SendAsync(request);
        return response.IsSuccessStatusCode;
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Failed to send webhook to {Url}", tenant.NotificationUrl);
        return false;
    }
}

// Application Tierce - Validation token OAuth2
[Authorize(Policy = "WebhookReceiver")]
[HttpPost("webhooks/johodp/verify-user")]
public async Task<IActionResult> ReceiveWebhook([FromBody] WebhookPayload payload)
{
    // Token OAuth2 dÃ©jÃ  validÃ© par le middleware ASP.NET Core
    // VÃ©rifier scopes/claims dans User.Claims
    
    if (!User.HasClaim("scope", "webhook.receive"))
        return Forbid();
    
    // Valider rÃ¨gles mÃ©tier
    var isValid = await _businessRules.ValidateUserRegistration(payload.Email);
    
    if (isValid)
    {
        // Appeler Johodp pour crÃ©er l'utilisateur
        await _johodpClient.RegisterUserAsync(payload);
        return Ok();
    }
    
    return BadRequest("User validation failed");
}
```

### Architecture SÃ©curitÃ© Webhook

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            SÃ‰CURITÃ‰ WEBHOOK (OAuth2)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Johodp (Ã‰metteur):                                      â”‚
â”‚  1. Obtenir access_token depuis Identity Server tiers   â”‚
â”‚     POST https://auth.thirdparty.com/connect/token      â”‚
â”‚     - grant_type: client_credentials                    â”‚
â”‚     - client_id: johodp-webhook-client                  â”‚
â”‚     - client_secret: <secret>                           â”‚
â”‚     - scope: webhook.receive                            â”‚
â”‚                                                          â”‚
â”‚  2. Appeler webhook avec Bearer token                   â”‚
â”‚     POST https://api.acme.com/webhooks/johodp/...       â”‚
â”‚     Authorization: Bearer <access_token>                â”‚
â”‚                                                          â”‚
â”‚  Application Tierce (RÃ©cepteur):                        â”‚
â”‚  1. Valider JWT token (signature, expiration)           â”‚
â”‚     - Issuer: https://auth.thirdparty.com               â”‚
â”‚     - Audience: api.acme.com                            â”‚
â”‚     - Scope: webhook.receive                            â”‚
â”‚                                                          â”‚
â”‚  2. Middleware ASP.NET Core JWT Bearer                  â”‚
â”‚     [Authorize(Policy = "WebhookReceiver")]             â”‚
â”‚                                                          â”‚
â”‚  3. VÃ©rifier claims/scopes spÃ©cifiques                  â”‚
â”‚     if (!User.HasClaim("scope", "webhook.receive"))     â”‚
â”‚         return Forbid();                                â”‚
â”‚                                                          â”‚
â”‚  Avantages OAuth2:                                      â”‚
â”‚  âœ… Standard OAuth2 (pas de crypto custom)              â”‚
â”‚  âœ… Tokens expirables (refresh automatique)             â”‚
â”‚  âœ… RÃ©vocation centralisÃ©e (Identity Server)            â”‚
â”‚  âœ… Scopes granulaires (webhook.receive, webhook.send)  â”‚
â”‚  âœ… Audit trail (qui a appelÃ©, quand, avec quel token)  â”‚
â”‚  âœ… Pas de secret partagÃ© Ã  synchroniser                â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Configuration Tenant

```csharp
// Domain/Tenants/Aggregates/Tenant.cs
public class Tenant : AggregateRoot
{
    // Webhook configuration
    public string? NotificationUrl { get; private set; }
    
    public void ConfigureNotification(string url)
    {
        if (!string.IsNullOrWhiteSpace(url))
        {
            if (!Uri.TryCreate(url, UriKind.Absolute, out var uri))
                throw new ArgumentException("Invalid notification URL");
            
            if (uri.Scheme != "https" && !IsLocalDevelopment())
                throw new ArgumentException("Notification URL must be HTTPS in production");
            
            NotificationUrl = url;
        }
        
        UpdatedAt = DateTime.UtcNow;
    }
}

// Infrastructure - Configuration OAuth2 pour webhooks
public class WebhookConfiguration
{
    public string ClientId { get; set; } = string.Empty;
    public string ClientSecret { get; set; } = string.Empty;
    public string TokenEndpoint { get; set; } = string.Empty;
    public string Scope { get; set; } = "webhook.receive";
    public int TokenCacheDurationMinutes { get; set; } = 50; // Cache token (< expiration 1h)
}
```

### DiffÃ©rences vs Appels API Classiques

| CaractÃ©ristique | Webhook (Johodp â†’ App) | API Call (App â†’ Johodp) |
|----------------|------------------------|-------------------------|
| **Direction** | Sortante (push) | Entrante (pull) |
| **DÃ©clencheur** | Ã‰vÃ©nement interne Johodp | Action utilisateur app |
| **Authentification** | OAuth2 Bearer token (client credentials) | OAuth2 Bearer token (client credentials) |
| **Identity Server** | Identity Server tiers (app tierce) | Johodp Identity Server |
| **SynchronicitÃ©** | Asynchrone (fire & forget) | Synchrone (attente rÃ©ponse) |
| **Retry** | Oui (exponential backoff) | Non (client responsable) |
| **Timeout** | 5 minutes pour rÃ©pondre | ImmÃ©diat |
| **Idempotence** | Requise (multiples envois possibles) | RecommandÃ©e |
| **TraÃ§abilitÃ©** | X-Johodp-Request-Id | correlationId dans headers |
| **Token caching** | Oui (< 1h expiration) | Oui (gÃ©rÃ© par client) |

### Extension / Ã‰volutions futures

#### File d'attente persistÃ©e (Outbox Pattern)

```sql
CREATE TABLE webhook_outbox (
    id UUID PRIMARY KEY,
    tenant_id UUID NOT NULL,
    event_type VARCHAR(100) NOT NULL, -- 'user.verification'
    payload JSONB NOT NULL,
    signature VARCHAR(255) NOT NULL,
    status VARCHAR(50) NOT NULL, -- 'pending', 'sent', 'failed'
    attempts INT DEFAULT 0,
    max_attempts INT DEFAULT 3,
    next_retry_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    sent_at TIMESTAMP,
    failed_at TIMESTAMP,
    error_message TEXT
);

CREATE INDEX idx_webhook_outbox_status ON webhook_outbox(status);
CREATE INDEX idx_webhook_outbox_next_retry ON webhook_outbox(next_retry_at) 
    WHERE status = 'pending';
```

#### Retry avec Exponential Backoff

```csharp
public async Task<bool> SendWebhookWithRetry(WebhookOutboxMessage message)
{
    var delays = new[] { 0, 30, 300, 1800 }; // 0s, 30s, 5min, 30min
    
    for (int attempt = 0; attempt < message.MaxAttempts; attempt++)
    {
        try
        {
            await Task.Delay(TimeSpan.FromSeconds(delays[attempt]));
            
            // Obtenir token OAuth2 (avec cache)
            var accessToken = await _tokenCache.GetOrCreateAsync(
                "webhook_token",
                async entry =>
                {
                    entry.AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(50);
                    return await GetAccessTokenForWebhook();
                }
            );
            
            var request = new HttpRequestMessage(HttpMethod.Post, message.Url);
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);
            request.Content = new StringContent(message.Payload, Encoding.UTF8, "application/json");
            
            var response = await _httpClient.SendAsync(request);
            
            if (response.IsSuccessStatusCode)
            {
                message.MarkAsSent();
                return true;
            }
            
            // Si 401 Unauthorized, vider cache et retry
            if (response.StatusCode == HttpStatusCode.Unauthorized)
            {
                _tokenCache.Remove("webhook_token");
            }
            
            message.IncrementAttempts($"HTTP {response.StatusCode}");
        }
        catch (Exception ex)
        {
            message.IncrementAttempts(ex.Message);
        }
    }
    
    message.MarkAsFailed();
    return false;
}
```

#### Token Caching (Performance)

```csharp
// Infrastructure/Services/WebhookTokenCache.cs
public class WebhookTokenCache
{
    private readonly IMemoryCache _cache;
    private readonly IHttpClientFactory _httpClientFactory;
    private readonly WebhookConfiguration _config;
    
    public async Task<string> GetOrCreateTokenAsync()
    {
        return await _cache.GetOrCreateAsync("webhook_access_token", async entry =>
        {
            // Cache token jusqu'Ã  50min (avant expiration 1h)
            entry.AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(50);
            
            var client = _httpClientFactory.CreateClient();
            var request = new HttpRequestMessage(HttpMethod.Post, _config.TokenEndpoint);
            request.Content = new FormUrlEncodedContent(new[]
            {
                new KeyValuePair<string, string>("grant_type", "client_credentials"),
                new KeyValuePair<string, string>("client_id", _config.ClientId),
                new KeyValuePair<string, string>("client_secret", _config.ClientSecret),
                new KeyValuePair<string, string>("scope", _config.Scope)
            });
            
            var response = await client.SendAsync(request);
            response.EnsureSuccessStatusCode();
            
            var tokenResponse = await response.Content.ReadFromJsonAsync<TokenResponse>();
            return tokenResponse.AccessToken;
        });
    }
}
```

### RÃ©fÃ©rences Documentation

- **SpÃ©cification payload & headers**: `API_ENDPOINTS.md` (section Webhook)
- **User Stories**: `USER_STORIES.md` (US-4.2 Onboarding, US-3.1 crÃ©ation via API)
- **Use Cases**: `USE_CASES.md` (UC-04 Onboarding, UC-05 Activation)
- **Flow complet**: `ONBOARDING_FLOW.md`
- **SÃ©curitÃ©**: `CORS_SECURITY.md`

## Avantages de cette Architecture

âœ… **SÃ©paration des prÃ©occupations (SoC)** - Chaque couche a une responsabilitÃ© unique et bien dÃ©finie
âœ… **TestabilitÃ© maximale** - Facile de tester chaque couche indÃ©pendamment (unit, integration, e2e)
âœ… **MaintenabilitÃ©** - Code organisÃ©, lisible, et facile Ã  maintenir sur le long terme
âœ… **Ã‰volutivitÃ©** - Architecture extensible, ajout de nouvelles fonctionnalitÃ©s sans refactoring massif
âœ… **Domain-Driven Design (DDD)** - La logique mÃ©tier est au cÅ“ur, pas couplÃ©e Ã  l'infrastructure
âœ… **CQRS friendly** - SÃ©paration naturelle read/write, optimisation indÃ©pendante
âœ… **Multi-tenant isolation** - Isolation stricte par TenantId, pas de fuite de donnÃ©es cross-tenant
âœ… **OAuth2/OIDC standard** - Authentification standardisÃ©e, compatible avec tous les clients OAuth2
âœ… **Branding flexible** - CustomConfiguration partageable, cohÃ©rence multi-tenant
âœ… **CORS granulaire** - Configuration au niveau tenant, agrÃ©gation dynamique par client
âœ… **Webhook extensible** - Validation mÃ©tier externe, intÃ©gration tierce sÃ©curisÃ©e
âœ… **Event-Driven ready** - Domain events pour dÃ©couplage, event sourcing futur possible
âœ… **Clean Architecture** - DÃ©pendances pointent vers le domaine (inversion de dÃ©pendances)

## SchÃ©ma de DÃ©pendances (Dependency Inversion)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Layer                             â”‚
â”‚  - Controllers, Middleware, IdentityServer config        â”‚
â”‚  - DÃ©pend de: Application, Domain, Infrastructure       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ (rÃ©fÃ©rence)
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Application Layer (CQRS)                    â”‚
â”‚  - Commands, Queries, Validators, DTOs                   â”‚
â”‚  - DÃ©pend de: Domain uniquement                         â”‚
â”‚  - Infrastructure injectÃ©e via DI                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ (rÃ©fÃ©rence)
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Domain Layer (DDD)                       â”‚
â”‚  - Aggregates, Value Objects, Domain Events              â”‚
â”‚  - PAS de dÃ©pendances externes (sauf .NET BCL)          â”‚
â”‚  - Interfaces dÃ©finies ici, implÃ©mentÃ©es ailleurs        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ (interface)
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Infrastructure Layer                          â”‚
â”‚  - EF Core, PostgreSQL, SMTP, IdentityServer             â”‚
â”‚  - ImplÃ©mente interfaces du Domain                       â”‚
â”‚  - DÃ©pend de: Domain, Application (pour DI)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Principe: Les dÃ©pendances pointent TOUJOURS vers le domaine (centre)
```

## Pattern DDD Enumeration

### Pourquoi Enumeration class plutÃ´t que enum C# ?

Les `enum` C# ont des limitations importantes en Domain-Driven Design :

âŒ **Valeurs par dÃ©faut problÃ©matiques** - `default(UserStatus)` = 0, peut causer des bugs
âŒ **Pas de comportement** - Impossible d'ajouter de la logique mÃ©tier
âŒ **Primitive obsession** - Les enums sont essentiellement des int
âŒ **Pas extensible** - Impossible d'ajouter des mÃ©thodes ou propriÃ©tÃ©s

### Solution : Enumeration base class

Notre implÃ©mentation suit le pattern de **Jimmy Bogard** :

```csharp
// Domain/Common/Enumeration.cs
public abstract class Enumeration : IComparable
{
    public int Value { get; private set; }
    public string Name { get; private set; }

    protected Enumeration(int value, string name)
    {
        Value = value;
        Name = name;
    }

    public static IEnumerable<T> GetAll<T>() where T : Enumeration
        => typeof(T).GetFields(BindingFlags.Public | BindingFlags.Static | BindingFlags.DeclaredOnly)
                     .Select(f => f.GetValue(null))
                     .Cast<T>();

    public static T FromValue<T>(int value) where T : Enumeration
        => GetAll<T>().FirstOrDefault(e => e.Value == value) 
           ?? throw new InvalidOperationException($"'{value}' n'est pas valide pour {typeof(T)}");

    public static T FromName<T>(string name) where T : Enumeration
        => GetAll<T>().FirstOrDefault(e => e.Name == name) 
           ?? throw new InvalidOperationException($"'{name}' n'est pas valide pour {typeof(T)}");

    public static bool operator ==(Enumeration left, Enumeration right)
        => left?.Value == right?.Value;

    public static bool operator !=(Enumeration left, Enumeration right)
        => !(left == right);

    public override bool Equals(object obj)
        => obj is Enumeration other && Value.Equals(other.Value);

    public override int GetHashCode() => Value.GetHashCode();

    public int CompareTo(object obj)
        => obj is Enumeration other ? Value.CompareTo(other.Value) : 1;
}
```

### Exemple : UserStatus Enumeration

```csharp
// Domain/Users/Aggregates/User.cs
public class UserStatus : Enumeration
{
    // Instances statiques - type-safe, pas de valeur par dÃ©faut
    public static readonly UserStatus PendingActivation = new(0, nameof(PendingActivation));
    public static readonly UserStatus Active = new(1, nameof(Active));
    public static readonly UserStatus Suspended = new(2, nameof(Suspended));
    public static readonly UserStatus Deleted = new(3, nameof(Deleted));

    // Constructeur privÃ© - seules les instances statiques peuvent exister
    private UserStatus(int value, string name) : base(value, name) { }

    // MÃ©thodes comportementales - logique mÃ©tier dans le domaine
    public bool CanActivate() => this == PendingActivation;
    public bool CanLogin() => this == Active;
    public bool CanSuspend() => this == Active;
    public bool IsDeleted() => this == Deleted;
}
```

### Utilisation dans l'agrÃ©gat User

```csharp
public class User : AggregateRoot<UserId>
{
    // PropriÃ©tÃ© avec valeur par dÃ©faut explicite
    public UserStatus Status { get; private set; } = UserStatus.PendingActivation;
    
    // PropriÃ©tÃ© calculÃ©e - pas de colonne en base
    public bool IsActive => Status == UserStatus.Active;

    public void Activate()
    {
        if (!Status.CanActivate())
            throw new InvalidOperationException("L'utilisateur ne peut pas Ãªtre activÃ©");
        
        Status = UserStatus.Active;
        ActivatedAt = DateTime.UtcNow;
        AddDomainEvent(new UserActivatedEvent(Id));
    }

    public void Suspend()
    {
        if (!Status.CanSuspend())
            throw new InvalidOperationException("L'utilisateur ne peut pas Ãªtre suspendu");
        
        Status = UserStatus.Suspended;
        AddDomainEvent(new UserSuspendedEvent(Id));
    }
}
```

### Configuration EF Core

```csharp
// Infrastructure/Persistence/Configurations/UserConfiguration.cs
public class UserConfiguration : IEntityTypeConfiguration<User>
{
    public void Configure(EntityTypeBuilder<User> builder)
    {
        // Conversion Enumeration â†” int pour la base de donnÃ©es
        builder.Property(x => x.Status)
               .HasConversion(
                   v => v.Value,  // Enumeration â†’ int (sauvegarde)
                   v => UserStatus.FromValue<UserStatus>(v))  // int â†’ Enumeration (lecture)
               .IsRequired();

        // Ignorer les propriÃ©tÃ©s calculÃ©es
        builder.Ignore(x => x.IsActive);
    }
}
```

### Avantages obtenus

âœ… **Type-safe** - Impossible d'utiliser des valeurs invalides
âœ… **Pas de valeur par dÃ©faut** - `Status = UserStatus.PendingActivation` est explicite
âœ… **Comportement riche** - `Status.CanActivate()`, `Status.CanLogin()`
âœ… **Logique mÃ©tier dans le domaine** - Pas dans les controllers ou services
âœ… **ExtensibilitÃ©** - Facile d'ajouter nouvelles mÃ©thodes ou propriÃ©tÃ©s
âœ… **LisibilitÃ©** - `if (user.Status.CanLogin())` vs `if (user.Status == 1)`
âœ… **Refactoring-friendly** - Changements de valeurs sans casser le code
âœ… **Compatible EF Core** - Stockage en int, conversion transparente

### Comparaison enum vs Enumeration

| CaractÃ©ristique | enum C# | Enumeration class |
|----------------|---------|-------------------|
| Type-safe | âœ… | âœ… |
| Valeur par dÃ©faut | âŒ `default = 0` | âœ… Explicite |
| Comportement mÃ©tier | âŒ Impossible | âœ… MÃ©thodes |
| ExtensibilitÃ© | âŒ LimitÃ© | âœ… IllimitÃ© |
| LisibilitÃ© | âš ï¸ Moyen | âœ… Excellent |
| Performance | âœ… Rapide | âš ï¸ LÃ©gÃ¨rement plus lent |
| Storage DB | âœ… int | âœ… int (HasConversion) |

