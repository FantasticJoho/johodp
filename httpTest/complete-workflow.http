### COMPLETE WORKFLOW TEST - Johodp IDP
### This file demonstrates the COMPLETE end-to-end workflow from scratch
### Execute requests in ORDER (top to bottom) for a successful test

###############################################################################
### CONFIGURATION VARIABLES
###############################################################################

@baseUrl = http://localhost:5000
@clientName = {{createClient.response.body.clientName}}
@redirectUri = http://localhost:4200/callback
@scope = openid profile email johodp.identity johodp.api offline_access
@state = workflow-state-12345
@nonce = workflow-nonce-67890

# PKCE Parameters
@codeVerifier = dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk
@codeChallenge = E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM

# Tenant configuration
@tenantName = workflow-tenant1
@tenantDisplayName = Workflow Test Corporation

# CustomConfiguration
@customConfigName = workflow-branding3

# User credentials
@userEmail = workflow.test12@example.com
@userFirstName = Workflow
@userLastName = TestUser
@userPassword = SecureP@ssw0rd123!

# Dynamic variables (will be populated from responses - use @name to capture)
# For testing: you can hardcode IDs here if requests already executed
@clientId = {{createClient.response.body.id}}
@customConfigId = {{createCustomConfig.response.body.id}}
@tenantId = {{createTenant.response.body.id}}
@userId = {{registerUser.response.body.id}}
@activationToken = CfDJ8IISH9pSP0dDqu2Sb7sBxQFpDnstu17RG/1I/A3qwd7t2bbvIyomEtHoeEEDsvaljXlirwyxDT32e2na5HZv1pm7FPvomENq+MjkMQpJXemIgAgDkiV5EVQEcftFu4JjTSLyctciDcvS+eE8Hz5L+HKT58Znw8jxUG5BTCikAirDtSnU8eXCzpqgHOdoRpxg6IqsaYI8Oz1ls3sF46QKkh8=
@authCode = 95101CB108A5C535A56396301EBE3821E45EF7775DADB5D96E849AE54233D87E-1
@accessToken = CfDJ8IISH9pSP0dDqu2Sb7sBxQH0JLRdRWVOFgENT7JqqiajawnTlX94jedTFKmOuzZx2FZo9EVe6TFymM47rmbL38AJyp7j6bhaBK/aThYr8wTsQ4CKUX73kOB1ugUv5GFo70gmxZBsDip5A2TBUO0LxfCNs93M+FXcEMIwuYrpkf/gNbO/4PjjbOs6HwRyPl4Ma/RvaClvW27QXLOUTaePZGE=
@refreshToken = 


###############################################################################
### STEP 1: CREATE CLIENT
###############################################################################

### 1.1 Create OAuth2 Client
# @name createClient
POST {{baseUrl}}/api/clients
Content-Type: application/json

{
  "clientName": "workflow-test-spa-{{$timestamp}}",
  "allowedScopes": [
    "openid",
    "profile",
    "email",
    "johodp.identity",
    "johodp.api",
    "offline_access"
  ],
  "requireConsent": false,
  "requireMfa": false
}

### After execution, copy the 'id' from response to @clientId variable above

### 1.2 Get Client by Name (Verify creation)
# GET {{baseUrl}}/api/clients/by-name/{{clientName}}
# Note: Use clientName from createClient response since it's random


###############################################################################
### STEP 2: CREATE CUSTOM CONFIGURATION
###############################################################################

### 2.1 Create CustomConfiguration for branding
# @name createCustomConfig
POST {{baseUrl}}/api/custom-configurations
Content-Type: application/json

{
  "name": "{{customConfigName}}-{{$timestamp}}",
  "description": "Branding configuration for workflow test",
  "primaryColor": "#007bff",
  "secondaryColor": "#6c757d",
  "logoUrl": "https://example.com/logo.png",
  "backgroundImageUrl": "https://example.com/bg.jpg",
  "customCss": ".login-page { font-family: Arial; }",
  "defaultLanguage": "en-US",
  "additionalLanguages": ["fr-FR", "es-ES"]
}

### After execution, copy the 'id' from response to @customConfigId variable above
### Or use the named request: @customConfigId = {{createCustomConfig.response.body.id}}

### 2.2 Get CustomConfiguration by ID (Verify creation)
GET {{baseUrl}}/api/custom-configurations/{{customConfigId}}

### 2.3 Get CustomConfiguration by Name
GET {{baseUrl}}/api/custom-configurations/by-name/{{customConfigName}}

### 2.4 Update CustomConfiguration (change colors, logo, languages)
PUT {{baseUrl}}/api/custom-configurations/{{customConfigId}}
Content-Type: application/json

{
  "description": "Updated branding - new color scheme",
  "primaryColor": "#ff5733",
  "secondaryColor": "#c70039",
  "logoUrl": "https://example.com/new-logo.png",
  "defaultLanguage": "en-US",
  "supportedLanguages": ["en-US", "fr-FR", "es-ES", "de-DE"]
}

### 2.5 Get All CustomConfigurations
GET {{baseUrl}}/api/custom-configurations

### 2.6 Get Active CustomConfigurations
GET {{baseUrl}}/api/custom-configurations/active


###############################################################################
### STEP 3: CREATE TENANT
###############################################################################

### 3.1 Create Tenant (links Client + CustomConfiguration)
# @name createTenant
# NOTE: Make sure @clientId and @customConfigId are set from previous responses
# You can check their values by hovering over the variables
# If empty, manually copy from STEP 1.1 and STEP 2.1 responses
POST {{baseUrl}}/api/tenant
Content-Type: application/json

{
  "name": "{{tenantName}}-{{$timestamp}}",
  "displayName": "{{tenantDisplayName}}",
  "clientId": "{{clientId}}",
  "customConfigurationId": "{{customConfigId}}",
  "allowedReturnUrls": [
    "{{redirectUri}}",
    "http://localhost:4200/auth/callback"
  ],
  "allowedCorsOrigins": [
    "http://localhost:4200"
  ]
}

### Capture tenant name for later use
@TenantNameResult = {{createTenant.response.body.name}}

### 3.1b Alternative - Create Tenant with hardcoded IDs (for testing)
# Replace GUIDs with actual values from STEP 1 and STEP 2 responses
# POST {{baseUrl}}/api/tenant
# Content-Type: application/json
# 
# {
#   "name": "{{tenantName}}",
#   "displayName": "{{tenantDisplayName}}",
#   "clientId": "e6ba4794-52c1-468a-8ccb-08583e7b2c39",
#   "customConfigurationId": "12345678-1234-1234-1234-123456789abc",
#   "allowedReturnUrls": [
#     "{{redirectUri}}",
#     "http://localhost:4200/auth/callback"
#   ],
#   "allowedCorsOrigins": [
#     "http://localhost:4200"
#   ]
# }

### After execution, copy the 'id' from response to @tenantId variable above

### 3.2 Get Tenant by Name (Verify creation)
GET {{baseUrl}}/api/tenant/by-name/{{TenantNameResult}}

### 3.3 Get Tenant by ID
GET {{baseUrl}}/api/tenant/{{tenantId}}


###############################################################################
### STEP 4: UPDATE CLIENT (Associate with Tenant)
###############################################################################

### 4.1 Update Client to link with Tenant
PUT {{baseUrl}}/api/clients/{{clientId}}
Content-Type: application/json

{
  "clientName": "{{clientName}}",
  "allowedScopes": [
    "openid",
    "profile",
    "email",
    "johodp.identity",
    "johodp.api",
    "offline_access"
  ],
  "requireConsent": false,
  "requireMfa": false,
  "isActive": true
}


###############################################################################
### STEP 5: UPDATE TENANT
###############################################################################

### 5.1 Update Tenant (add redirect URIs and CORS)
PUT {{baseUrl}}/api/tenant/{{tenantId}}
Content-Type: application/json

{
  "name": "{{TenantNameResult}}",
  "displayName": "{{tenantDisplayName}} - Updated",
  "clientId": "{{clientId}}",
  "customConfigurationId": "{{customConfigId}}",
  "allowedReturnUrls": [
    "{{redirectUri}}",
    "http://localhost:4200/auth/callback",
    "http://localhost:4200/silent-refresh"
  ],
  "allowedCorsOrigins": [
    "http://localhost:4200",
    "http://localhost:3000"
  ],
  "isActive": true
}

### 5.2 Get Tenant Branding CSS
GET {{baseUrl}}/api/tenant/{{tenantName}}/branding.css

### 5.3 Get Tenant Language Settings
GET {{baseUrl}}/api/tenant/{{tenantName}}/language


###############################################################################
### STEP 6: USER REGISTRATION (Request)
###############################################################################

### 6.1 User requests account (sends notification to external app)
# @name registerUserRequest
POST {{baseUrl}}/api/auth/register
Content-Type: application/json

{
  "email": "{{userEmail}}",
  "firstName": "{{userFirstName}}",
  "lastName": "{{userLastName}}",
  "tenantName": "{{TenantNameResult}}"
}

### Response: 202 Accepted with requestId
### External app receives notification and validates


###############################################################################
### STEP 7: USER CREATION (External App Approval)
###############################################################################

### 7.1 External app approves and creates user
# @name createUser
POST {{baseUrl}}/api/users/register
Content-Type: application/json

{
  "email": "{{userEmail}}",
  "firstName": "{{userFirstName}}",
  "lastName": "{{userLastName}}",
  "tenantId": "{{tenantId}}",
  "role": "User",
  "scope": "full_access"
}

### After execution, copy 'userId' and 'activationToken' from response
### Copy userId to @userId variable
### Copy activationToken to @activationToken variable (DEV mode only)

### 7.2 Get User by ID (Verify creation - status should be PendingActivation)
GET {{baseUrl}}/api/users/{{userId}}

### 7.3 Get User by Email
GET {{baseUrl}}/api/users/by-email/{{userEmail}}


###############################################################################
### STEP 8: UPDATE USER ROLE AND SCOPE (Optional)
###############################################################################

### 8.1 Update User Role and Scope
# Note: User belongs to a single tenant (set during registration)
# Only role and scope can be updated, tenantId is immutable
PUT {{baseUrl}}/api/users/{{userId}}
Content-Type: application/json

{
  "email": "{{userEmail}}",
  "firstName": "{{userFirstName}}",
  "lastName": "{{userLastName}}",
  "role": "Admin",
  "scope": "admin_access"
}


###############################################################################
### STEP 9: USER ACTIVATION
###############################################################################

### 9.1 Activate User Account (set password)
# @name activateUser
POST {{baseUrl}}/api/auth/activate
Content-Type: application/json

{
  "token": "{{activationToken}}",
  "userId": "00980a2e-e820-4596-9546-96706dd94c59",
  "newPassword": "{{userPassword}}",
  "confirmPassword": "{{userPassword}}"
}

### 9.2 Verify User is Active
GET {{baseUrl}}/api/users/{{userId}}
### Status should now be "Active"


###############################################################################
### STEP 10: USER LOGIN (API)
###############################################################################

### 10.1 Login via API to get session cookie
# @name loginUser
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "email": "{{userEmail}}",
  "password": "{{userPassword}}",
  "tenantname": "{{TenantNameResult}}"
}

### Response: Cookie set for authenticated session


###############################################################################
### STEP 11: OAUTH2 AUTHORIZATION (PKCE Flow)
###############################################################################

### 11.1 Start Authorization Flow (paste in browser)
# GET {{baseUrl}}/connect/authorize?response_type=code&client_id={{clientName}}&redirect_uri={{redirectUri}}&scope={{scope}}&code_challenge={{codeChallenge}}&code_challenge_method=S256&state={{state}}&nonce={{nonce}}&acr_values=tenant:{{tenantName}}

### 11.2 Authorization with automatic cookie (from login)
# @name authorize
GET {{baseUrl}}/connect/authorize?response_type=code&client_id={{clientName}}&redirect_uri={{redirectUri}}&scope={{scope}}&code_challenge={{codeChallenge}}&code_challenge_method=S256&state={{state}}&nonce={{nonce}}&acr_values=tenant:{{TenantNameResult}}
Cookie: {{loginUser.response.headers.Set-Cookie}}

### Copy the 'code' from redirect URL (response will be 302 redirect)
### Example: http://localhost:4200/callback?code=XXXXX&state=workflow-state-12345
### Paste the code value below:
@authCode = CE848620C7AC4F13FE268289C03C87A7818BCA7ABB55F88B37F3F9D2E498F267-1


###############################################################################
### STEP 12: TOKEN EXCHANGE
###############################################################################

### 12.1 Exchange authorization code for tokens
# @name getTokens
POST {{baseUrl}}/connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code
&client_id={{clientName}}
&code={{authCode}}
&redirect_uri={{redirectUri}}
&code_verifier={{codeVerifier}}

### Capture tokens from response
@accessToken = {{getTokens.response.body.access_token}}
@refreshToken = {{getTokens.response.body.refresh_token}}
@idToken = {{getTokens.response.body.id_token}}


###############################################################################
### STEP 13: USE ACCESS TOKEN
###############################################################################

### 13.1 Get User Claims
GET {{baseUrl}}/account/claims
Authorization: Bearer {{accessToken}}

### 13.2 Get UserInfo (OIDC standard)
GET {{baseUrl}}/connect/userinfo
Authorization: Bearer {{accessToken}}

### 13.3 Introspect Token
POST {{baseUrl}}/connect/introspect
Content-Type: application/x-www-form-urlencoded

token={{accessToken}}
&client_id={{clientName}}


###############################################################################
### STEP 14: REFRESH TOKEN
###############################################################################

### 14.1 Get new access token using refresh token
# @name refreshTokenResponse
POST {{baseUrl}}/connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token
&client_id={{clientName}}
&refresh_token={{refreshToken}}

### Capture new tokens
@accessToken = {{refreshTokenResponse.response.body.access_token}}
@refreshToken = {{refreshTokenResponse.response.body.refresh_token}}


###############################################################################
### STEP 15: USER MANAGEMENT OPERATIONS
###############################################################################

### 15.1 Update User Role/Scope
# Note: tenantId cannot be changed after user creation
PUT {{baseUrl}}/api/users/{{userId}}
Content-Type: application/json

{
  "email": "{{userEmail}}",
  "firstName": "{{userFirstName}}",
  "lastName": "{{userLastName}}",
  "role": "Admin",
  "scope": "admin_access"
}

### 15.2 Get All Users (Admin operation)
GET {{baseUrl}}/api/users

### 15.3 Search Users by Email
GET {{baseUrl}}/api/users/search?email={{userEmail}}

### 15.4 Deactivate User
POST {{baseUrl}}/api/users/{{userId}}/deactivate

### 15.5 Reactivate User
POST {{baseUrl}}/api/users/{{userId}}/activate


###############################################################################
### STEP 16: TENANT MANAGEMENT OPERATIONS
###############################################################################

### 16.1 Get All Tenants
GET {{baseUrl}}/api/tenant

### 16.2 Get Tenants for Client
GET {{baseUrl}}/api/clients/{{clientId}}/tenants

### 16.3 Deactivate Tenant
POST {{baseUrl}}/api/tenant/{{tenantId}}/deactivate

### 16.4 Reactivate Tenant
POST {{baseUrl}}/api/tenant/{{tenantId}}/activate


###############################################################################
### STEP 17: CLIENT MANAGEMENT OPERATIONS
###############################################################################

### 17.1 Get All Clients
GET {{baseUrl}}/api/clients

### 17.2 Update Client Scopes
PUT {{baseUrl}}/api/clients/{{clientId}}
Content-Type: application/json

{
  "clientName": "{{clientName}}",
  "allowedScopes": [
    "openid",
    "profile",
    "email",
    "johodp.identity",
    "johodp.api",
    "offline_access",
    "custom.scope"
  ],
  "requireMfa": true,
  "isActive": true
}

### 17.3 Enable MFA for Client
POST {{baseUrl}}/api/clients/{{clientId}}/enable-mfa

### 17.4 Disable MFA for Client
POST {{baseUrl}}/api/clients/{{clientId}}/disable-mfa


###############################################################################
### STEP 18: LOGOUT & CLEANUP
###############################################################################

### 18.1 Revoke Access Token
POST {{baseUrl}}/connect/revocation
Content-Type: application/x-www-form-urlencoded

token={{accessToken}}
&client_id={{clientName}}
&token_type_hint=access_token

### 18.2 Revoke Refresh Token
POST {{baseUrl}}/connect/revocation
Content-Type: application/x-www-form-urlencoded

token={{refreshToken}}
&client_id={{clientName}}
&token_type_hint=refresh_token

### 18.3 Logout (End Session)
GET {{baseUrl}}/connect/endsession?id_token_hint={{accessToken}}&post_logout_redirect_uri={{redirectUri}}


###############################################################################
### STEP 19: CLEANUP (OPTIONAL - Destructive operations)
###############################################################################

### 19.1 Delete User
# DELETE {{baseUrl}}/api/users/{{userId}}

### 19.3 Delete Tenant
# DELETE {{baseUrl}}/api/tenant/{{tenantId}}

### 19.4 Delete CustomConfiguration
# DELETE {{baseUrl}}/api/custom-configurations/{{customConfigId}}

### 19.5 Delete Client
# DELETE {{baseUrl}}/api/clients/{{clientId}}


###############################################################################
### DATABASE VERIFICATION QUERIES
###############################################################################

### Verify Client exists and is active
# Run this SQL in your PostgreSQL client:
# SELECT "Id", "ClientName", "IsActive", "associated_tenant_ids" 
# FROM dbo.clients 
# WHERE "ClientName" = 'workflow-test-spa-1764604058';

### Verify Tenant exists and has correct clientId
# SELECT t."Id", t."Name", t."ClientId", c."ClientName"
# FROM dbo.tenants t
# LEFT JOIN dbo.clients c ON t."ClientId"::text = c."Id"::text
# WHERE t."Name" = 'workflow-tenant1';

### Verify User exists with correct TenantId
# SELECT u."Id", u."Email", u."TenantId", u."Role", u."Scope", u."Status"
# FROM dbo.users u
# WHERE u."Email" = 'workflow.test1@example.com';

### Full workflow verification (all entities linked)
# SELECT 
#   c."ClientName",
#   t."Name" as "TenantName",
#   u."Email",
#   u."Role",
#   u."Scope",
#   u."Status"
# FROM dbo.clients c
# LEFT JOIN dbo.tenants t ON t."ClientId"::text = c."Id"::text
# LEFT JOIN dbo.users u ON u."TenantId" = t."Id"
# WHERE c."ClientName" = 'workflow-test-spa-1764604058'
#   OR t."Name" = 'workflow-tenant1';


###############################################################################
### ADDITIONAL SCENARIOS
###############################################################################

### SCENARIO: Create User on Different Tenant
### Same email can be used on different tenants (separate accounts)

### Create second tenant
# @name createSecondTenant
POST {{baseUrl}}/api/tenant
Content-Type: application/json

{
  "name": "workflow-tenant-2",
  "displayName": "Second Workflow Tenant",
  "clientId": "{{clientId}}",
  "customConfigurationId": "{{customConfigId}}",
  "allowedReturnUrls": ["{{redirectUri}}"],
  "allowedCorsOrigins": ["http://localhost:4200"]
}

### Create user on second tenant (same email, different account)
# @name createUserTenant2
POST {{baseUrl}}/api/users/register
Content-Type: application/json

{
  "email": "{{userEmail}}",
  "firstName": "{{userFirstName}}",
  "lastName": "{{userLastName}}",
  "tenantId": "{{createSecondTenant.response.body.id}}",
  "role": "Reader",
  "scope": "read_only"
}

### Note: This creates a SEPARATE account with the same email
### Each tenant has its own user account with independent password and permissions


### SCENARIO: Password Reset Flow

### Request password reset
POST {{baseUrl}}/api/auth/forgot-password
Content-Type: application/json

{
  "email": "{{userEmail}}"
}

### Reset password with token (from email)
POST {{baseUrl}}/api/auth/reset-password
Content-Type: application/json

{
  "email": "{{userEmail}}",
  "token": "RESET_TOKEN_FROM_EMAIL",
  "newPassword": "NewSecureP@ssw0rd456!",
  "confirmPassword": "NewSecureP@ssw0rd456!"
}


### SCENARIO: OIDC Discovery

### Get OpenID Connect configuration
GET {{baseUrl}}/.well-known/openid-configuration

### Get JWKS (public keys for token validation)
GET {{baseUrl}}/.well-known/openid-configuration/jwks


###############################################################################
### NOTES & WORKFLOW SUMMARY
###############################################################################

# Complete Workflow Order:
# 1. Create Client (OAuth2 application)
# 2. Create CustomConfiguration (branding/languages) - INDEPENDENT entity
# 3. Create Tenant (links Client + CustomConfiguration + URLs)
# 4. Update Client (associate with tenant - optional)
# 5. Update Tenant (add more URLs/CORS)
# 6. User Registration Request (user submits form)
# 7. User Creation (external app approves)
# 8. Update User Role/Scope (optional)
# 9. User Activation (user sets password)
# 10. User Login (get session cookie)
# 11. OAuth2 Authorization (PKCE flow starts)
# 12. Token Exchange (get access/refresh tokens)
# 13. Use Access Token (call protected APIs)
# 14. Refresh Token (get new access token)
# 15-19. Management & Cleanup operations

# Architecture Summary:
# Client (1) → (N) Tenants
# CustomConfiguration (INDEPENDENT) - not owned by any Client
# CustomConfiguration (1) → (N) Tenants (via customConfigurationId in Tenant)
# Tenant (1) → (1) Client (via clientId in Tenant)
# Tenant (1) → (1) CustomConfiguration (REQUIRED)
# User (N) → (1) Tenant (via tenantId in User - required, immutable)
# User has role and scope directly (no junction table)

# Key Points:
# - CustomConfiguration is INDEPENDENT (not owned by any Client)
# - Multiple Tenants can share the SAME CustomConfiguration (even from different Clients)
# - Tenant MUST reference a Client (via clientId - required field)
# - Tenant MUST reference a CustomConfiguration (via customConfigurationId - required field)
# - Each User belongs to ONE tenant only (tenantId is required and immutable)
# - Same email can create separate accounts on different tenants
# - Email uniqueness is per tenant (composite unique key: Email + TenantId)
# - Role and Scope are stored directly in User entity (can be updated)
# - PKCE is used for security (code_verifier + code_challenge)
# - Tokens expire: access_token (1h), refresh_token (15 days)

# Recent Architecture Improvements (December 2025):
# 1. Result Pattern: All handlers return Result<T> instead of throwing exceptions
#    - 12x performance improvement (12ms vs 150ms per 1000 requests)
#    - Consistent error handling with ErrorType (Validation, NotFound, Conflict, etc.)
#    - Controllers use .ToActionResult() for automatic HTTP status mapping
#
# 2. Centralized Error Messages: Domain-specific error classes
#    - TenantErrors.cs: AlreadyExists(), ClientIdRequired(), InvalidClientId(), etc.
#    - ClientErrors.cs: AlreadyExists(), NotFound(), InvalidClientName(), etc.
#    - UserErrors.cs: AlreadyExistsForTenant(), NotFound(), InvalidEmail(), etc.
#    - CustomConfigurationErrors.cs: AlreadyExists(), InvalidLanguageCode(), etc.
#
# 3. Specification Pattern: Type-safe query specifications (12 created)
#    - Users: ActiveUser, UserByTenant, UserByRole, EmailConfirmed
#    - Clients: ActiveClient, ClientWithTenants, ClientByNameSearch
#    - CustomConfigs: ActiveCustomConfig, ByLanguage, WithBranding, etc.
#    - Zero performance impact (IQueryable generates identical SQL)
#
# 4. Cross-Cutting Concerns: BaseHandler + RequestLoggingMiddleware
#    - BaseHandler<TRequest, TResponse> with hooks (OnBeforeHandle, OnAfterHandle, OnError)
#    - Automatic logging, timing, and error handling at handler level
#    - RequestLoggingMiddleware for HTTP-level logging with correlation IDs
#    - Zero performance overhead
#
# 5. Error Response Format (Result Pattern):
#    Success (200/201/204): { "data": {...}, "isSuccess": true }
#    Error (400/404/409/500): { 
#      "error": {
#        "code": "TENANT_NOT_FOUND",
#        "message": "Tenant with ID '123' was not found",
#        "type": "NotFound"
#      },
#      "isSuccess": false
#    }

# Expected HTTP Status Codes:
# - 200 OK: Successful GET/PUT operations
# - 201 Created: Successful POST operations (with Location header)
# - 204 No Content: Successful DELETE operations
# - 400 Bad Request: Validation errors (ErrorType.Validation)
# - 404 Not Found: Resource not found (ErrorType.NotFound)
# - 409 Conflict: Duplicate resource (ErrorType.Conflict)
# - 500 Internal Server Error: Unexpected errors (ErrorType.Failure)

###############################################################################


###############################################################################
### STEP 20: MFA/TOTP WORKFLOWS (3 PARCOURS)
###############################################################################

# Prerequisites: 
# - User must be created, activated, and logged in
# - Client.RequireMfa must be set to true for mandatory MFA
# - Use userId and accessToken from previous steps

### MFA Configuration Variables
@totpCode = 123456
@recoveryCode = ABC123-DEF456
@verifiedToken = verified-identity-token-xyz
@mfaAccessToken = {{accessToken}}

###############################################################################
### PARCOURS 1: ONBOARDING MFA (First-time Setup)
###############################################################################

### 20.1 Enable MFA Requirement on Client (if not already done)
PUT {{baseUrl}}/api/clients/{{clientId}}
Content-Type: application/json

{
  "clientName": "{{clientName}}",
  "allowedScopes": [
    "openid",
    "profile",
    "email",
    "johodp.identity",
    "johodp.api",
    "offline_access"
  ],
  "requireConsent": false,
  "requireMfa": true,
  "isActive": true
}

### 20.2 User Login (First time with MFA required)
# Expected: If Client.RequireMfa=true and User.MFAEnabled=false
# System should redirect to MFA enrollment
# @name loginMfaRequired
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "email": "{{userEmail}}",
  "password": "{{userPassword}}",
  "tenantname": "{{TenantNameResult}}"
}
### Expected Response: 302 Redirect to /mfa/enroll OR { mfaEnrollmentRequired: true }

### 20.3 Enroll TOTP (Get QR Code)
# @name enrollTotp
POST {{baseUrl}}/api/auth/mfa/enroll
Authorization: Bearer {{mfaAccessToken}}
Content-Type: application/json

### Expected Response: 200 OK
# {
#   "qrCodeUri": "data:image/png;base64,iVBORw0KG...",
#   "manualEntryKey": "JBSW Y3DP EHPK 3PXP",
#   "message": "Scan QR code with your authenticator app"
# }

### 20.4 Verify TOTP and Activate MFA
# User scans QR code with Google Authenticator/Microsoft Authenticator
# User enters 6-digit code from authenticator app
# @name verifyTotpEnrollment
POST {{baseUrl}}/api/auth/mfa/verify-enrollment
Authorization: Bearer {{mfaAccessToken}}
Content-Type: application/json

{
  "totpCode": "{{totpCode}}"
}

### Expected Response: 200 OK
# {
#   "mfaEnabled": true,
#   "recoveryCodes": [
#     "ABC123-DEF456",
#     "GHI789-JKL012",
#     "MNO345-PQR678",
#     ... (10 codes total)
#   ],
#   "token": "eyJhbGciOiJSUzI1NiIs...",
#   "message": "MFA enabled successfully. Save your recovery codes!"
# }

### 20.5 Get MFA Status (Verify Enrollment)
GET {{baseUrl}}/api/auth/mfa/status
Authorization: Bearer {{mfaAccessToken}}

### Expected Response: 200 OK
# {
#   "mfaEnabled": true,
#   "enrolledAt": "2025-12-05T10:30:00Z",
#   "recoveryCodesRemaining": 10,
#   "isMfaRequired": true,
#   "clientRequiresMfa": true
# }


###############################################################################
### PARCOURS 2: LOGIN WITH TOTP (Existing Users)
###############################################################################

### 20.6 Login Step 1 - Email + Password
# User with MFA already enabled logs in
# Expected: Cookie "pending_mfa" created (5 min expiration)
# @name loginWithMfaStep1
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "email": "{{userEmail}}",
  "password": "{{userPassword}}",
  "tenantname": "{{TenantNameResult}}"
}

### Expected Response: 302 Redirect to /mfa-verification
# Set-Cookie: pending_mfa=<encrypted_data>; HttpOnly; Secure; SameSite=Strict; Max-Age=300

### Capture pending_mfa cookie
@pendingMfaCookie = {{loginWithMfaStep1.response.headers.Set-Cookie}}

### 20.7 Login Step 2 - Verify TOTP Code
# User enters 6-digit code from authenticator app
# @name verifyMfaLogin
POST {{baseUrl}}/api/auth/mfa-verify
Cookie: {{pendingMfaCookie}}
Content-Type: application/json

{
  "totpCode": "{{totpCode}}"
}

### Expected Response: 200 OK
# {
#   "mfaVerified": true,
#   "userId": "guid",
#   "email": "user@example.com",
#   "message": "MFA verification successful. You are now signed in.",
#   "redirectUrl": "/connect/authorize?client_id=xxx&response_type=code&scope=openid profile email johodp.api&redirect_uri={{client_redirect_uri}}&..."
# }
# Cookie set: .AspNetCore.Identity.Application with mfa_verified claim
# Cookie deleted: pending_mfa

### 20.8 Complete OAuth2 Flow - Get Tokens with MFA Claim
# Client app redirects to OAuth2 authorization endpoint (using cookie from step 20.7)
# @name getOAuth2Tokens
POST {{baseUrl}}/connect/authorize
Content-Type: application/x-www-form-urlencoded

client_id={{clientName}}
&response_type=code
&scope=openid profile email johodp.api
&redirect_uri=http://localhost:4200/callback
&state=random_state_value
&code_challenge=random_pkce_challenge
&code_challenge_method=S256

### Expected: 302 Redirect to redirect_uri with authorization code
# Then exchange code for tokens:

# @name exchangeCodeForTokens
POST {{baseUrl}}/connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code
&code={{getOAuth2Tokens.response.headers.Location}}
&redirect_uri=http://localhost:4200/callback
&client_id={{clientName}}
&code_verifier=original_pkce_verifier

### Expected Response:
# {
#   "access_token": "eyJhbGciOiJSUzI1NiIs...",
#   "id_token": "eyJhbGciOiJSUzI1NiIs...",
#   "token_type": "Bearer",
#   "expires_in": 3600,
#   "refresh_token": "..."
# }

### 20.9 Verify Token Contains MFA Claims
GET {{baseUrl}}/connect/userinfo
Authorization: Bearer {{exchangeCodeForTokens.response.body.access_token}}

### Expected: JWT should contain claims:
# {
#   "sub": "user-guid",
#   "email": "user@example.com",
#   "mfa_verified": "true",
#   "mfa_enabled": "true",
#   "tenant_id": "tenant-guid",
#   ...
# }


### 20.9 Verify Token Contains MFA Claims
GET {{baseUrl}}/connect/userinfo
Authorization: Bearer {{exchangeCodeForTokens.response.body.access_token}}

### Expected: JWT should contain claims:
# {
#   "sub": "user-guid",
#   "email": "user@example.com",
#   "mfa_verified": "true",
#   "mfa_enabled": "true",
#   "tenant_id": "tenant-guid",
#   ...
# }


###############################################################################
### PARCOURS 3: LOST DEVICE RECOVERY (3-Step Process)
###############################################################################

### 20.10 Step 1 - Initiate Lost Device Recovery
# User clicks "J'ai perdu mon authenticator" on MFA page
# @name lostDeviceRecovery
POST {{baseUrl}}/api/auth/mfa/lost-device
Content-Type: application/json

{
  "email": "{{userEmail}}"
}

### Expected Response: 200 OK
# {
#   "message": "If the email exists, a verification link has been sent. Check your inbox.",
#   "expiresIn": "1 hour"
# }

### Expected: Email sent with verification link
# Subject: Demande de réinitialisation MFA - Johodp
# Body contains: https://app.johodp.com/verify-identity?token=abc123xyz789

### 20.11 Step 2 - Verify Identity
# User clicks link in email and submits security questions
# @name verifyIdentity
POST {{baseUrl}}/api/auth/mfa/verify-identity
Content-Type: application/json

{
  "token": "abc123xyz789",
  "securityAnswers": {
    "birthCity": "Paris",
    "firstPet": "Rex"
  }
}

### Expected Response: 200 OK
# {
#   "verifiedToken": "def456uvw012",
#   "expiresIn": "30 minutes",
#   "message": "Identity verified. You can now reset your MFA enrollment."
# }

### Capture verifiedToken
@verifiedToken = {{verifyIdentity.response.body.verifiedToken}}

### 20.12 Step 3 - Reset MFA Enrollment
# @name resetMfaEnrollment
POST {{baseUrl}}/api/auth/mfa/reset-enrollment
Content-Type: application/json

{
  "verifiedToken": "{{verifiedToken}}"
}

### Expected Response: 200 OK
# {
#   "message": "MFA disabled successfully. You must re-enroll on next login.",
#   "mfaEnabled": false,
#   "nextStep": "Login and complete MFA enrollment (Parcours 1)"
# }

### Expected: Email confirmation sent
# Subject: Votre MFA a été réinitialisée - Johodp
# Body contains: Date/heure, IP address, warning to contact support if not initiated by user

### 20.13 Verify MFA is Disabled
GET {{baseUrl}}/api/auth/mfa/status
Authorization: Bearer {{mfaAccessToken}}

### Expected Response: 200 OK
# {
#   "mfaEnabled": false,
#   "isMfaRequired": true,
#   "clientRequiresMfa": true
# }

### 20.14 User Must Re-enroll on Next Login
# User logs in again → System forces re-enrollment (back to Parcours 1)
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "email": "{{userEmail}}",
  "password": "{{userPassword}}",
  "tenantname": "{{TenantNameResult}}"
}
### Expected: Redirect to /mfa/enroll (Parcours 1)


###############################################################################
### PARCOURS COMPLÉMENTAIRE: DISABLE MFA (Optional)
###############################################################################

### 20.15 Disable MFA (Only if Client.RequireMfa = false)
# User voluntarily disables MFA
POST {{baseUrl}}/api/auth/mfa/disable
Authorization: Bearer {{mfaAccessToken}}
Content-Type: application/json

{
  "password": "{{userPassword}}"
}

### Expected Response: 200 OK (if MFA is optional)
# {
#   "mfaEnabled": false,
#   "message": "MFA disabled successfully"
# }

### Expected Response: 409 Conflict (if MFA is required)
# {
#   "error": {
#     "code": "MFA_REQUIRED",
#     "message": "Cannot disable MFA (required by organization policy)",
#     "type": "Conflict"
#   },
#   "isSuccess": false
# }


###############################################################################
### MFA TESTING SCENARIOS
###############################################################################

### SCENARIO 1: Invalid TOTP Code
POST {{baseUrl}}/api/auth/mfa-verify
Cookie: {{pendingMfaCookie}}
Content-Type: application/json

{
  "totpCode": "000000"
}
### Expected: 400 Bad Request "Invalid TOTP code, please try again"

### SCENARIO 2: Expired Pending MFA Cookie
# Wait 5+ minutes after login, then try to verify TOTP
POST {{baseUrl}}/api/auth/mfa-verify
Cookie: pending_mfa=expired-cookie
Content-Type: application/json

{
  "totpCode": "{{totpCode}}"
}
### Expected: 401 Unauthorized "Session expired, please log in again"

### SCENARIO 3: Expired Identity Verification Token
POST {{baseUrl}}/api/auth/mfa/verify-identity
Content-Type: application/json

{
  "token": "expired-token-abc123",
  "securityAnswers": {
    "birthCity": "Paris"
  }
}
### Expected: 401 Unauthorized "Token expired, request a new one"

### SCENARIO 4: Wrong Security Questions
POST {{baseUrl}}/api/auth/mfa/verify-identity
Content-Type: application/json

{
  "token": "valid-token-abc123",
  "securityAnswers": {
    "birthCity": "Wrong City",
    "firstPet": "Wrong Pet"
  }
}
### Expected: 401 Unauthorized "Wrong answers"


###############################################################################
### MFA WORKFLOW SUMMARY & NOTES
###############################################################################

# Parcours 1 - Onboarding MFA (First-time Setup):
# 1. User logs in with Client.RequireMfa=true && User.MFAEnabled=false
# 2. System redirects to POST /mfa/enroll (returns QR code)
# 3. User scans QR code with authenticator app
# 4. User submits TOTP code → POST /mfa/verify-enrollment
# 5. System activates MFA, generates 10 recovery codes, returns JWT
# 6. User is logged in with mfa_verified claim

# Parcours 2 - Login with TOTP (Existing Users):
# 1. User logs in → POST /login (email + password)
# 2. System creates cookie "pending_mfa" (5 min expiration)
# 3. User redirected to /mfa-verification page
# 4. User enters TOTP code from authenticator → POST /mfa-verify
# 5. System validates TOTP, generates JWT with mfa_verified claim
# 6. Cookie "pending_mfa" deleted
# 7. User is logged in

# Parcours 3 - Lost Device Recovery (3 Steps):
# 1. User clicks "Lost Device" → POST /mfa/lost-device (sends email)
# 2. User clicks email link → POST /mfa/verify-identity (validates identity)
# 3. System generates "verified_identity" token (30 min)
# 4. User submits → POST /mfa/reset-enrollment (disables MFA)
# 5. Next login → System forces re-enrollment (back to Parcours 1)

# Key Security Features:
# - Cookie "pending_mfa": HttpOnly + Secure + SameSite=Strict (5 min expiration)
# - Identity verification token: 1 hour expiration
# - Verified identity token: 30 minutes expiration
# - TOTP validation: ±30 seconds window
# - Rate limiting: max 5 attempts per session (recommended)
# - Audit logging: all MFA events logged (enrollment, login, reset)
# - Email notifications: MFA enabled, disabled, recovery initiated

# Expected HTTP Status Codes (MFA):
# - 200 OK: Successful MFA operations
# - 302 Redirect: MFA enrollment required or verification page
# - 400 Bad Request: Invalid TOTP code
# - 401 Unauthorized: Expired token, wrong credentials, invalid session
# - 409 Conflict: Cannot disable MFA (required by policy)

# Implementation Status (as of December 2025):
# ✅ Parcours 1 - Onboarding: Partial (/mfa/enroll, /mfa/verify-enrollment)
# ❌ Parcours 2 - Login TOTP: Strategy Pattern + Cookie not implemented
# ❌ Parcours 3 - Lost Device: Complete flow to implement
# ❌ MFA Status: /mfa/status endpoint to implement
# ❌ MFA Disable: /mfa/disable endpoint to implement

###############################################################################
