# Configuration Nginx pour Johodp Identity Provider
# Redirige uniquement vers les endpoints existants

upstream johodp_backend {
    server localhost:5000;  # Port HTTP de l'application
    # Pour HTTPS: server localhost:5001;
}

server {
    listen 80;
    server_name idp.example.com;  # Remplacer par votre domaine
    
    # Redirection HTTP -> HTTPS (décommenter en production)
    # return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name idp.example.com;  # Remplacer par votre domaine
    
    # Configuration SSL (à adapter selon vos certificats)
    # ssl_certificate /etc/nginx/ssl/cert.pem;
    # ssl_certificate_key /etc/nginx/ssl/key.pem;
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers HIGH:!aNULL:!MD5;
    
    # Logs
    access_log /var/log/nginx/johodp_access.log;
    error_log /var/log/nginx/johodp_error.log;
    
    # Limites de taille
    client_max_body_size 10M;
    
    # Headers de sécurité
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # ====================
    # ENDPOINTS OAUTH2/OIDC (IdentityServer)
    # ====================
    
    # Authorization endpoint (OAuth2 authorize)
    location ~ ^/connect/authorize {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Token endpoint (échange de code, refresh token, client credentials)
    location = /connect/token {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # UserInfo endpoint (informations utilisateur)
    location = /connect/userinfo {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # End session endpoint (logout)
    location = /connect/endsession {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Revocation endpoint (révocation de tokens)
    location = /connect/revocation {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Discovery document (OpenID Connect discovery)
    location = /.well-known/openid-configuration {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache pour 1 heure
        proxy_cache_valid 200 1h;
        add_header Cache-Control "public, max-age=3600";
    }
    
    # JWKS (clés publiques pour validation des tokens)
    location = /.well-known/openid-configuration/jwks {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache pour 1 heure
        proxy_cache_valid 200 1h;
        add_header Cache-Control "public, max-age=3600";
    }
    
    # ====================
    # ENDPOINTS API - AUTHENTICATION (AccountController)
    # ====================
    
    # Login (email + password)
    location = /api/auth/login {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Logout
    location = /api/auth/logout {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Register (inscription utilisateur)
    location = /api/auth/register {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Activate account (activation compte avec token)
    location = /api/auth/activate {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Forgot password
    location = /api/auth/forgot-password {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Reset password
    location = /api/auth/reset-password {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # MFA Enroll (démarrer inscription TOTP)
    location = /api/auth/mfa/enroll {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # MFA Verify Enrollment (valider inscription TOTP)
    location = /api/auth/mfa/verify-enrollment {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Login with TOTP (connexion avec double authentification)
    location = /api/auth/login-with-totp {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ====================
    # ENDPOINTS API - USERS (UsersController)
    # ====================
    
    # User registration (via API)
    location = /api/users/register {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Get user by ID
    location ~ ^/api/users/[a-fA-F0-9-]+$ {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ====================
    # ENDPOINTS API - TENANTS (TenantController)
    # ====================
    
    # Get all tenants (GET), Create tenant (POST)
    location = /api/tenant {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Get tenant by ID (GET), Update tenant (PUT), Delete tenant (DELETE)
    location ~ ^/api/tenant/[a-fA-F0-9-]+$ {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Get tenant by name
    location ~ ^/api/tenant/by-name/[^/]+$ {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Get tenant branding CSS (public endpoint)
    location ~ ^/api/tenant/[^/]+/branding\.css$ {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache CSS for 5 minutes
        proxy_cache_valid 200 5m;
        add_header Cache-Control "public, max-age=300";
        add_header Content-Type "text/css";
    }
    
    # Get tenant language settings
    location ~ ^/api/tenant/[^/]+/language$ {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ====================
    # ENDPOINTS API - CLIENTS (ClientsController)
    # ====================
    
    # Create client (POST)
    location = /api/clients {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Get client by ID (GET), Update client (PUT)
    location ~ ^/api/clients/[a-fA-F0-9-]+$ {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Get client by name
    location ~ ^/api/clients/by-name/[^/]+$ {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ====================
    # ENDPOINTS API - CUSTOM CONFIGURATIONS (CustomConfigurationsController)
    # ====================
    
    # Get all custom configurations (GET), Create custom configuration (POST)
    location = /api/custom-configurations {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Get active custom configurations
    location = /api/custom-configurations/active {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Get custom configuration by name
    location ~ ^/api/custom-configurations/by-name/[^/]+$ {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Get custom configuration by ID (GET), Update (PUT), Delete (DELETE)
    location ~ ^/api/custom-configurations/[a-fA-F0-9-]+$ {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ====================
    # ENDPOINTS DE TEST (à désactiver en production)
    # ====================
    
    # Test OAuth2 flow
    location ~ ^/test/(authorize|callback) {
        # Décommenter pour désactiver en production:
        # return 404;
        
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ====================
    # STATIC FILES (wwwroot)
    # ====================
    
    # Page d'accueil statique
    location = / {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    location = /index.html {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ====================
    # HEALTH CHECK
    # ====================
    
    # Health check - Liveness (Kubernetes: l'app est-elle vivante?)
    location = /health/live {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        access_log off;
    }
    
    # Health check - Readiness (Kubernetes: l'app est-elle prête pour le trafic?)
    location = /health/ready {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        access_log off;
    }
    
    # Health check - General (monitoring, load balancers)
    location = /health {
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        access_log off;
    }
    
    # ====================
    # MIGRATIONS (Development only)
    # ====================
    
    # Migration endpoints (désactiver en production dans le contrôleur)
    location ~ ^/api/migrations/(up|down|status)$ {
        # Décommenter pour bloquer complètement en production:
        # return 404;
        
        proxy_pass http://johodp_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ====================
    # BLOCAGE PAR DÉFAUT
    # ====================
    
    # Bloquer tous les autres endpoints non explicitement autorisés
    location / {
        return 404;
    }
}
