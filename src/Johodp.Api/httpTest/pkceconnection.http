### PKCE Flow - Complete OAuth2 Authorization Code + PKCE Workflow
### This file demonstrates user registration, activation, and the full PKCE flow for obtaining tokens

### Variables
@baseUrl = http://localhost:5000
@clientId = johodp-spa
@redirectUri = http://localhost:4200/callback
@scope = openid profile email johodp.identity johodp.api
@state = 5a223df34572489a89678a698307af5e
@nonce = a1f6d229e9ee4aada5652fa77a853f46

# PKCE Parameters (generate these for each flow)
# code_verifier: random string 43-128 chars (base64url encoded)
# code_challenge: base64url(SHA256(code_verifier))
@codeVerifier = dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk
@codeChallenge = E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM

# Tenant (optional - use tenant:your-tenant-id or omit for wildcard access)
@tenantId = acme-corp
@acrValues = tenant:{{tenantId}}

# User credentials (will be set after registration and activation)
@userEmail = test.user@example2.com
@userPassword = MySecureP@ssw0rd123!

# Authorization code (will be obtained from Step 2)
@authorizationCode = DFF80F7186B7E703BFF10D80CF18269F355182A11B2308C9F72B56889AF72AF0-1

# Access token (will be obtained from Step 3)
@accessToken = eyJhbGciOiJSUzI1NiIsImtpZCI6IjNGODNDODU3MzBDMjQ4NTU2NTUyNjc4MzRGQTY0RUQwIiwidHlwIjoiYXQrand0In0.eyJpc3MiOiJodHRwczovL2xvY2FsaG9zdDo1MDAxIiwibmJmIjoxNzYzNjU3MDc3LCJpYXQiOjE3NjM2NTcwNzcsImV4cCI6MTc2MzY2MDY3NywiYXVkIjoiam9ob2RwIiwic2NvcGUiOlsib3BlbmlkIiwicHJvZmlsZSIsImVtYWlsIiwiam9ob2RwLmlkZW50aXR5Iiwiam9ob2RwLmFwaSJdLCJhbXIiOlsicHdkIl0sImNsaWVudF9pZCI6ImpvaG9kcC1zcGEiLCJzdWIiOiJhNDBkZWUyYi1jZDI4LTRkYjYtYTNiMi04OWVjYmQyZmZkMDYiLCJhdXRoX3RpbWUiOjE3NjM2NTY5NTcsImlkcCI6ImxvY2FsIiwiZW1haWwiOiJ0ZXN0LnVzZXJAZXhhbXBsZTEuY29tIiwidGVuYW50X2lkIjoiYWNtZS1jb3JwIiwicm9sZSI6InJlYWRlciIsInBlcm1pc3Npb24iOiJyZWFkZXIiLCJzaWQiOiI1NzI5RUFDNkFBRjU3NjBEMjk1NDA4QTUxM0E3RDhFMiIsImp0aSI6IjAxMDJEQzAyODQyREEyMThDM0RFMEFCNzlGMDFENTAzIn0.lQMQdctTsPCRrXxG0_e_kzS-TfCjmOq-wvXqwxu8LZkIcEoYs0cRB5tiafFmGhSbt9PvqIJn-TUP7K0Wu1pml6oi8iPNQMq4DJ6CNHGUAtDgkbQJlMBwKNDcjzWT440kkTnQH9Mo36RopFEF3KM4zrh5dlX_kP4Kzs8nXmjQyFLNprgtzE-Wa5Hsfjhkyn1Oynq5vriBvlQc4coOTA_Ai9OZKuEmMCrfHAuaauHSk6hijB-uwu5-Aj2micVEO8ANVo8HaJie3Az0X9oTvOOxxMUujYP3JiSd-zO_OksBgDFCCnfng10-6wN1vV80FmvuVobJnZTkV1kOek0Kesmqrg




###############################################################################
### ADMIN OPERATIONS: CLIENT MANAGEMENT
###############################################################################

### Create OAuth2 Client (REQUIRED before creating tenants)
# @name createClient
POST {{baseUrl}}/api/clients
Content-Type: application/json

{
  "clientName": "{{clientId}}",
  "allowedScopes": [
    "openid",
    "profile",
    "email",
    "johodp.identity",
    "johodp.api"
  ],
  "requireConsent": false,
  "requireMfa": false
}

### Extract clientId from creation response
@createdClientId = {{createClient.response.body.id}}

### Get Client by Name
GET {{baseUrl}}/api/clients/by-name/{{clientId}}

### Get Client by ID
GET {{baseUrl}}/api/clients/{{createdClientId}}

### Update Client (add tenant associations, enable MFA, etc.)
PUT {{baseUrl}}/api/clients/{{createdClientId}}
Content-Type: application/json

{
  "allowedScopes": [
    "openid",
    "profile",
    "email",
    "johodp.identity",
    "johodp.api",
    "offline_access"
  ],
  "associatedTenantIds": [
    "{{tenantId}}"
  ],
  "requireMfa": false,
  "isActive": true
}

### Delete Client
# DELETE {{baseUrl}}/api/clients/{{createdClientId}}


###############################################################################
### ADMIN OPERATIONS: TENANT MANAGEMENT
###############################################################################

### Create Tenant (REQUIRES existing client)
# @name createTenant
POST {{baseUrl}}/api/tenant
Content-Type: application/json

{
  "name": "{{tenantId}}",
  "displayName": "ACME Corporation",
  "defaultLanguage": "en-US",
  "supportedLanguages": [
    "en-US",
    "fr-FR"
  ],
  "timezone": "America/New_York",
  "currency": "USD",
  "primaryColor": "#0066CC",
  "secondaryColor": "#003366",
  "logoUrl": "https://example.com/acme-logo.png",
  "allowedReturnUrls": [
    "{{redirectUri}}",
    "https://acme.example.com/callback"
  ],
  "allowedCorsOrigins": [
    "http://localhost:4200",
    "https://acme.example.com"
  ],
  "clientId": "{{clientId}}"
}

### Extract tenantId from creation response
@createdTenantId = {{createTenant.response.body.id}}

### Get All Tenants
GET {{baseUrl}}/api/tenant

### Get Tenant by Name
GET {{baseUrl}}/api/tenant/by-name/{{tenantId}}

### Get Tenant by ID
GET {{baseUrl}}/api/tenant/{{createdTenantId}}

### Update Tenant (add redirect URIs, CORS origins, etc.)
PUT {{baseUrl}}/api/tenant/{{createdTenantId}}
Content-Type: application/json

{
  "displayName": "ACME Corporation International",
  "supportedLanguages": [
    "en-US",
    "fr-FR",
    "es-ES"
  ],
  "timezone": "America/New_York",
  "currency": "USD",
  "primaryColor": "#0066CC",
  "secondaryColor": "#003366",
  "logoUrl": "https://example.com/acme-logo-v2.png",
  "allowedReturnUrls": [
    "{{redirectUri}}",
    "https://acme.example.com/callback",
    "https://app.acme.com/auth/callback"
  ],
  "allowedCorsOrigins": [
    "http://localhost:4200",
    "https://acme.example.com",
    "https://app.acme.com"
  ],
  "associatedClientIds": [
    "{{clientId}}"
  ],
  "isActive": true
}

### Get Tenant Branding CSS (Public endpoint)
GET {{baseUrl}}/api/tenant/{{tenantId}}/branding.css

### Get Tenant Language Settings (Public endpoint)
GET {{baseUrl}}/api/tenant/{{tenantId}}/language

### Delete Tenant
# DELETE {{baseUrl}}/api/tenant/{{createdTenantId}}




###############################################################################
### STEP 0: USER REGISTRATION & ACTIVATION (Before Login)
###############################################################################

### Step 0.1: Register New User (WITHOUT password - sends notification to external app)
# @name registerUser
POST {{baseUrl}}/api/auth/register
Content-Type: application/json

{
  "email": "{{userEmail}}",
  "firstName": "Test",
  "lastName": "User",
  "tenantId": "{{tenantId}}"
}

# Response (202 Accepted):
# - requestId: Unique request ID for tracking
# - email: User's email
# - tenantId: Associated tenant
# - status: "pending" (awaiting external validation)
# NOTE: User is NOT created yet - external app must validate and call /api/users/register

### Step 0.2: External App Validates and Creates User (this endpoint is called by external app)
# NOTE: This is typically done by your external application, not manually
# The external app receives the notification from Step 0.1 and decides to approve/reject
# If approved, it calls this endpoint to actually create the user
# @name createUserByExternalApp
POST {{baseUrl}}/api/users/register
Content-Type: application/json

{
  "email": "{{userEmail}}",
  "firstName": "Test",
  "lastName": "User",
  "tenantId": "{{tenantId}}",
  "requestId": "abc-123-from-notification"
}

# Response includes:
# - userId: GUID of created user
# - email: User's email
# - status: "PendingActivation"
# - activationToken: Token for email activation (DEV mode only)
# NOTE: In production, activation token is sent via email, not in response

### Extract userId from external app creation response
@registeredUserId = {{createUserByExternalApp.response.body.userId}}



###############################################################################
### ADMIN OPERATIONS: USER ROLE & PERMISSION MANAGEMENT
###############################################################################

### Assign Role to User
POST {{baseUrl}}/api/users/assign-role
Content-Type: application/json

{
  "userId": "{{registeredUserId}}",
  "roleName": "User"
}

# Available roles: TenantAdmin, User, Reader, etc.

### Assign Scope/Permission to User
POST {{baseUrl}}/api/users/assign-scope
Content-Type: application/json

{
  "userId": "{{registeredUserId}}",
  "scopeName": "users.write"
}

# Scopes represent fine-grained permissions
# Examples: users.read, users.write, tenants.manage, clients.manage

### Add User to Additional Tenant
POST {{baseUrl}}/api/users/{{registeredUserId}}/tenants
Content-Type: application/json

{
  "tenantId": "another-tenant"
}

### Remove User from Tenant
# DELETE {{baseUrl}}/api/users/{{registeredUserId}}/tenants/another-tenant

### Get User Details
GET {{baseUrl}}/api/users/{{registeredUserId}}

# Response includes:
# - id, email, firstName, lastName
# - tenantIds (array of tenant access)
# - roles (array of role names)
# - scopes (array of permission scopes)
# - status (Active, PendingActivation, etc.)






### Step 0.3: Activate User Account (User clicks link in email)
# IMPORTANT: Get the activation token from email or application console output (DEV mode)
# Replace YOUR_ACTIVATION_TOKEN_HERE with the actual token from console (without quotes)
@activationToken = CfDJ8IISH9pSP0dDqu2Sb7sBxQGOr7LD2uizpY9t6UkjBD6YMrt7TX/Hqusc7uj6IHkXfwETx9bq+l4SVe1YjxtInxASBsXvnKuVccv2I7gILXvyVYBM/ufcW9IIPPAI9obGigCdW0OC5SoeLfBv6pb0VVl2+zUjqLZ7EpWAU9GjwQXMHIWevVCyv7cNOhMzCc1wk+RBfSRsh7x4vligXDchSck=
# @name activateUser
POST {{baseUrl}}/api/auth/activate
Content-Type: application/json

{
  "token": "{{activationToken}}",
  "userId": "{{registeredUserId}}",
  "newPassword": "{{userPassword}}",
  "confirmPassword": "{{userPassword}}"
}

# Response: User is activated and can now log in with {{userEmail}} / {{userPassword}}


###############################################################################
### STEP 1: Discover OpenID Connect Configuration
###############################################################################

### Get OIDC Discovery Document
GET {{baseUrl}}/.well-known/openid-configuration
Accept: application/json

###############################################################################
### STEP 2: Authorization Request (Browser-based - manual step)
###############################################################################

### Authorization Endpoint - WITHOUT TENANT (wildcard access)
# Paste this URL in your browser to initiate the authorization flow
# GET {{baseUrl}}/connect/authorize?response_type=code&client_id={{clientId}}&redirect_uri={{redirectUri}}&scope={{scope}}&code_challenge={{codeChallenge}}&code_challenge_method=S256&state={{state}}&nonce={{nonce}}

### Authorization Endpoint - WITH SPECIFIC TENANT
# Paste this URL in your browser to initiate the authorization flow with tenant
 GET {{baseUrl}}/connect/authorize?response_type=code&client_id={{clientId}}&redirect_uri={{redirectUri}}&scope={{scope}}&code_challenge={{codeChallenge}}&code_challenge_method=S256&state={{state}}&nonce={{nonce}}&acr_values={{acrValues}}

# After successful login, you'll be redirected to:
# {{redirectUri}}?code=AUTHORIZATION_CODE&state={{state}}
# Copy the 'code' parameter value and update @authorizationCode variable above


###############################################################################
### STEP 3: Token Request (Exchange authorization code for tokens)
###############################################################################

### Exchange authorization code for access token
POST {{baseUrl}}/connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code
&client_id={{clientId}}
&code={{authorizationCode}}
&redirect_uri={{redirectUri}}
&code_verifier={{codeVerifier}}

# Response will include:
# - access_token: JWT token for API access
# - id_token: JWT with user identity claims
# - refresh_token: Token to get new access tokens
# - expires_in: Access token lifetime in seconds


###############################################################################
### STEP 4: Use Access Token to Call Protected API
###############################################################################

### Get User Claims (using access token)
GET {{baseUrl}}/account/claims
Authorization: Bearer {{accessToken}}
Cookie: .AspNetCore.Identity.Application=COOKIE_VALUE_IF_NEEDED


###############################################################################
### STEP 5: Get UserInfo (OIDC UserInfo Endpoint)
###############################################################################

### Get UserInfo
GET {{baseUrl}}/connect/userinfo
Authorization: Bearer {{accessToken}}


###############################################################################
### STEP 6: Refresh Token (Get new access token without re-authentication)
###############################################################################

### Refresh Access Token
# Replace with refresh_token from STEP 3 response
@refreshToken = YOUR_REFRESH_TOKEN_HERE

POST {{baseUrl}}/connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token
&client_id={{clientId}}
&refresh_token={{refreshToken}}


###############################################################################
### STEP 7: Revoke Token (Logout / Token Cleanup)
###############################################################################

### Revoke Access Token
POST {{baseUrl}}/connect/revocation
Content-Type: application/x-www-form-urlencoded

token={{accessToken}}
&client_id={{clientId}}
&token_type_hint=access_token


###############################################################################
### ALTERNATIVE: Direct Login API (for testing without browser)
###############################################################################

### Login via API - WITH SPECIFIC TENANT (recommended)
# @name loginApi
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "email": "{{userEmail}}",
  "password": "{{userPassword}}",
  "tenantId": "{{tenantId}}"
}

### Authorization Request - Using Cookie from Login (OPTION 1: Automatic)
# This request automatically uses cookies from the previous login
# Works with VS Code REST Client and most HTTP clients
GET {{baseUrl}}/connect/authorize?response_type=code&client_id={{clientId}}&redirect_uri={{redirectUri}}&scope={{scope}}&code_challenge={{codeChallenge}}&code_challenge_method=S256&state={{state}}&nonce={{nonce}}&acr_values={{acrValues}}

### Authorization Request - Using Cookie from Login (OPTION 2: Manual extraction)
# If automatic cookies don't work, use this version with explicit Cookie header
# @name authWithCookie
GET {{baseUrl}}/connect/authorize?response_type=code&client_id={{clientId}}&redirect_uri={{redirectUri}}&scope={{scope}}&code_challenge={{codeChallenge}}&code_challenge_method=S256&state={{state}}&nonce={{nonce}}&acr_values={{acrValues}}
Cookie: {{loginApi.response.headers.Set-Cookie}}

### Login via API - WITHOUT TENANT (creates user with wildcard access)
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "email": "{{userEmail}}",
  "password": "{{userPassword}}"
}

GET {{baseUrl}}/connect/authorize?response_type=code&client_id={{clientId}}&redirect_uri={{redirectUri}}&scope={{scope}}&code_challenge={{codeChallenge}}&code_challenge_method=S256&state={{state}}&nonce={{nonce}}&acr_values={{acrValues}}


###############################################################################
### ADDITIONAL USER OPERATIONS
###############################################################################

### Get User Details
GET {{baseUrl}}/api/users/{{registeredUserId}}

### Get User's Tenants
GET {{baseUrl}}/api/users/{{registeredUserId}}/tenants

### Add User to Additional Tenant
POST {{baseUrl}}/api/users/{{registeredUserId}}/tenants
Content-Type: application/json

{
  "tenantId": "another-tenant"
}

### Remove User from Tenant
DELETE {{baseUrl}}/api/users/{{registeredUserId}}/tenants/another-tenant


###############################################################################
### UTILITY: Introspect Token (validate and inspect token)
###############################################################################

### Introspect Access Token
POST {{baseUrl}}/connect/introspect
Content-Type: application/x-www-form-urlencoded

token={{accessToken}}
&client_id={{clientId}}



###############################################################################
### NOTES:
###############################################################################
# 
# Complete User Registration & Login Flow (NEW - API-only):
# STEP 0.1: User submits registration (NO password) → POST /api/auth/register → 202 Accepted
# STEP 0.2: External app validates → POST /api/users/register → User created (PendingActivation)
# STEP 0.3: User receives email → Clicks activation link → POST /api/auth/activate (defines password)
# STEP 1: Discover OIDC configuration
# STEP 2: Start authorization flow (browser) with PKCE
# STEP 3: Exchange authorization code for tokens
# STEP 4-7: Use tokens, refresh, revoke
#
# Admin Setup Flow (Complete tenant setup from scratch):
# ADMIN 1: Create Client → POST /api/clients (get clientId)
# ADMIN 2: Create Tenant → POST /api/tenant (link to clientId, set redirect URIs)
# ADMIN 3: Update Client → PUT /api/clients/{id} (associate with tenantId)
# ADMIN 4: Create Users → POST /api/users/register (for tenant)
# ADMIN 5: Assign Roles → POST /api/users/assign-role
# ADMIN 6: Assign Permissions → POST /api/users/assign-scope
#
# Registration Flow Details:
# 1. POST /api/auth/register (email, firstName, lastName, tenantId) → NO PASSWORD
#    → Returns 202 Accepted with requestId
#    → Sends notification to external app (fire-and-forget)
# 
# 2. External app validates the request (business logic, KYC, compliance)
#    → If approved: POST /api/users/register (creates user with PendingActivation)
#    → If rejected: No action (user never created)
#
# 3. User receives activation email with token (24h expiration)
#    → POST /api/auth/activate (token, userId, newPassword)
#    → Status changes to Active
#    → User can now login
#
# Client/Tenant Architecture:
# - Clients are associated with one or more tenants (via associatedTenantIds)
# - Redirect URIs AND CORS Origins are defined at the Tenant level (allowedReturnUrls and allowedCorsOrigins)
# - IdentityServer dynamically aggregates redirect URIs and CORS origins from all associated tenants
# - Workflow: Create Client → Create Tenant (with clientId) → Update Client (with tenantId)
# - A client is VISIBLE to IdentityServer only if:
#   1. It has at least one associated tenant, AND
#   2. The associated tenant(s) have at least one allowedReturnUrl configured
#
# PKCE Flow Steps:
# 1. Generate code_verifier (random 43-128 char string)
# 2. Generate code_challenge = base64url(SHA256(code_verifier))
# 3. Start authorization with code_challenge
# 4. User authenticates and approves
# 5. Receive authorization code
# 6. Exchange code + code_verifier for tokens
#
# User Status Values:
# - PendingActivation (0): Awaiting email activation
# - Active (1): Can log in
# - Suspended (2): Account disabled
# - Deleted (3): Soft deleted
#
# Tenant Support:
# - No acr_values: User gets wildcard access (TenantId = "*")
# - acr_values=tenant:xyz: User restricted to tenant "xyz"
# - Users with TenantId="*" can access any tenant
# - Users can belong to multiple tenants via POST /api/users/{id}/tenants
#
# JWT Token Claims:
# - Access tokens and ID tokens include custom claims when 'johodp.identity' scope is requested:
#   - tenant_id: User's assigned tenant (or "*" for wildcard)
#   - role: User's roles (multiple claims if user has multiple roles)
#   - permission: User's permissions (multiple claims if user has multiple permissions)
#
# Generate PKCE values in PowerShell:
# $verifier = -join ((65..90) + (97..122) + (48..57) + 45 + 95 | Get-Random -Count 128 | % {[char]$_})
# $sha256 = [System.Security.Cryptography.SHA256]::Create()
# $hash = $sha256.ComputeHash([System.Text.Encoding]::ASCII.GetBytes($verifier))
# $challenge = [Convert]::ToBase64String($hash).TrimEnd('=').Replace('+', '-').Replace('/', '_')
#
# Authorization Note:
# - ALL ENDPOINTS ARE PUBLIC (No authentication required) for development
# - In production, add proper authorization to sensitive endpoints
#
# Coherent Test Data Set:
# - Client: johodp-spa (SPA application)
# - Tenant: acme-corp (ACME Corporation)
# - User: test.user@example2.com (linked to acme-corp)
# - Redirect: http://localhost:4200/callback
# - All entities are related and work together in PKCE flow
#
###############################################################################
