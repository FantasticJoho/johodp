### Admin Operations - Client, Tenant and User Management
### This file demonstrates CRUD operations for Clients, Tenants and User registration

### Variables
@baseUrl = http://localhost:5000

###############################################################################
### CLIENT MANAGEMENT (All endpoints are public - No authentication required)
###############################################################################

### Create a new OAuth2 Client
# IMPORTANT: Clients CANNOT be created with a tenant association
# - Clients are created first, independently
# - Tenants are then created and must reference an existing client
# 
# A client is visible to IdentityServer only if:
#   1. It has at least one associated tenant
#   2. The associated tenant(s) have at least one allowedReturnUrl configured
#
# Note: Redirect URIs and CORS Origins are managed at the Tenant level, not directly on clients
# The client will inherit redirect URIs and CORS origins from all associated tenants
#
# RequireMfa: Set to true to enforce Multi-Factor Authentication (Microsoft Authenticator)
POST {{baseUrl}}/api/clients
Content-Type: application/json

{
  "clientName": "my-spa-app",
  "allowedScopes": [
    "openid",
    "profile",
    "email",
    "johodp.identity",
    "johodp.api"
  ],
  "requireConsent": false,
  "requireMfa": false
}

### Create a secure client WITH MFA (Microsoft Authenticator required)
POST {{baseUrl}}/api/clients
Content-Type: application/json

{
  "clientName": "secure-banking-app",
  "allowedScopes": [
    "openid",
    "profile",
    "email",
    "johodp.identity",
    "johodp.api",
    "banking.transactions"
  ],
  "requireConsent": true,
  "requireMfa": true
}

### Create another OAuth2 Client
POST {{baseUrl}}/api/clients
Content-Type: application/json

{
  "clientName": "my-other-app",
  "allowedScopes": [
    "openid",
    "profile",
    "email"
  ],
  "requireConsent": false
}

### Get Client by ID
@clientId = 61651e87-0194-4340-a574-da64271abef1
GET {{baseUrl}}/api/clients/{{clientId}}

### Get Client by Name
@clientName = my-other-app2
GET {{baseUrl}}/api/clients/by-name/{{clientName}}

### Update Client
# Note: Redirect URIs and CORS Origins are managed at the Tenant level
# To change redirect URIs or CORS origins, update the associated Tenant's allowedReturnUrls and allowedCorsOrigins
# You can change which tenants are associated with this client
# RequireMfa can be toggled to enable/disable Multi-Factor Authentication
PUT {{baseUrl}}/api/clients/{{clientId}}
Content-Type: application/json

{
  "allowedScopes": [
    "openid",
    "profile",
    "email",
    "johodp.identity",
    "johodp.api",
    "offline_access"
  ],
  "associatedTenantIds": [
    "acme-corp",
    "another-tenant-id"
  ],
  "requireMfa": true,
  "isActive": true
}

### Delete Client
# Note: Redirect URIs and CORS Origins are now managed at the Tenant level
# To add/modify redirect URIs or CORS origins, update the Tenant's allowedReturnUrls and allowedCorsOrigins properties
DELETE {{baseUrl}}/api/clients/{{clientId}}


###############################################################################
### TENANT MANAGEMENT (All endpoints are public - No authentication required)
###############################################################################

### Create a new Tenant
# IMPORTANT CONSTRAINTS:
# 1. A tenant MUST be associated with ONE client (clientId is required)
# 2. The client MUST already exist in the database before creating the tenant
# 3. Workflow: Create the client first, then create the tenant referencing that client
# 4. AllowedReturnUrls AND AllowedCorsOrigins are managed at the Tenant level
POST {{baseUrl}}/api/tenant
Content-Type: application/json

{
  "name": "acme-corp1",
  "displayName": "ACME Corporation",
  "defaultLanguage": "en-US",
  "supportedLanguages": [
    "en-US",
    "fr-FR",
    "es-ES"
  ],
  "timezone": "America/New_York",
  "currency": "USD",
  "primaryColor": "#0066CC",
  "secondaryColor": "#003366",
  "logoUrl": "https://example.com/acme-logo.png",
  "backgroundImageUrl": "https://example.com/acme-bg.jpg",
  "customCss": "body { font-family: 'Roboto', sans-serif; }",
  "allowedReturnUrls": [
    "http://localhost:4200/callback",
    "https://acme.example.com/callback"
  ],
  "allowedCorsOrigins": [
    "http://localhost:4200",
    "https://acme.example.com"
  ],
  "clientId": "my-spa-app"
}

### Get All Tenants
GET {{baseUrl}}/api/tenant

### Get Tenant by ID
@tenantId = 672a0fc2-23e3-478c-90b7-40baa8a3aa21
GET {{baseUrl}}/api/tenant/{{tenantId}}

### Get Tenant by Name
@tenantName = acme-corp
GET {{baseUrl}}/api/tenant/by-name/{{tenantName}}

### Update Tenant
PUT {{baseUrl}}/api/tenant/{{tenantId}}
Content-Type: application/json

{
  "displayName": "ACME Corporation International",
  "supportedLanguages": [
    "en-US",
    "fr-FR",
    "es-ES",
    "de-DE"
  ],
  "timezone": "America/New_York",
  "currency": "USD",
  "primaryColor": "#0066CC",
  "secondaryColor": "#003366",
  "logoUrl": "https://example.com/acme-logo-v2.png",
  "allowedReturnUrls": [
    "http://localhost:4200/callback",
    "https://acme.example.com/callback",
    "https://app.acme.com/auth/callback"
  ],
  "allowedCorsOrigins": [
    "http://localhost:4200",
    "https://acme.example.com",
    "https://app.acme.com"
  ],
  "associatedClientIds": [
    "my-spa-app",
    "acme-mobile-app",
    "acme-desktop-app"
  ],
  "isActive": true
}

### Get Tenant Branding CSS (Public - No Auth Required)
GET {{baseUrl}}/api/tenant/{{tenantName}}/branding.css

### Get Tenant Language Settings (Public - No Auth Required)
GET {{baseUrl}}/api/tenant/{{tenantName}}/language

### Delete Tenant
DELETE {{baseUrl}}/api/tenant/{{tenantId}}


###############################################################################
### USER MANAGEMENT - ONBOARDING FLOW
###############################################################################

### Step 1: User initiates onboarding (public endpoint)
# This is typically a GET request in a browser, but shown here for reference
# GET {{baseUrl}}/account/onboarding?acr_values=tenant:acme-corp&return_url=/

### Step 2: User submits onboarding form
# This sends a notification to the external tenant application
# The tenant app will validate and call the registration endpoint if approved
POST {{baseUrl}}/account/onboarding
Content-Type: application/x-www-form-urlencoded

email=john.doe@example.com
&firstName=John
&lastName=Doe
&tenantId=acme-corp
&returnUrl=%2F

# Response: Redirects to OnboardingPending view
# User will receive activation email ONLY if tenant app approves


###############################################################################
### USER MANAGEMENT - DIRECT REGISTRATION (All endpoints are public - No authentication required)
###############################################################################

### Register User (Creates user with PendingActivation status)
# @name registerUser
POST {{baseUrl}}/api/users/register
Content-Type: application/json

{
  "email": "jane.smith@examplev.com",
  "firstName": "Jane",
  "lastName": "Smith",
  "password": "TempP@ssw0rd123!",
  "tenantId": "acme-corp"
}

# Response includes:
# - userId: GUID of created user
# - email: User's email
# - status: "PendingActivation"
# - message: Confirmation message
# NOTE: Activation token is NOT returned in response for security
# In DEV mode, check console logs for activation token and URL

### Extract data from registration response
@registeredUserId = {{registerUser.response.body.userId}}

### Get the registered user details
GET {{baseUrl}}/api/users/{{registeredUserId}}

### Get user's tenants
GET {{baseUrl}}/api/users/{{registeredUserId}}/tenants

### Activate the registered user (API endpoint - Copy token from console logs)
# IMPORTANT: Get the token from application console output (DEV mode only)
##@activationToken = "CfDJ8IISH9pSP0dDqu2Sb7sBxQFFduQGDhVUre62GHbtirCSiG9ZJ0LERld0npSOsZHZYlrdR9yplHJVCHSB0YfGU3mW3EzFrczaZkcVU4WNebYyNCalxXWgrIe7qXuWbyBHjL0RwrEtG1DgZPtTZ0ILZtPnlLyF8eODlkHTDcNF592QfV+w0noIPsitC2h1zKBs+kKEWx68QCVnHcJb08eNb+U="
POST {{baseUrl}}/api/account/activate
Content-Type: application/json

{
  "token": "CfDJ8IISH9pSP0dDqu2Sb7sBxQHktOuKbRGcPPV5NhosiFNJWbF9aTZohF+//R6ArG0wtXQmZXULeXWqoS+NwIu5ojrqMdomXTZIBsHohQJp6p5POoKQVu9zpG9Gi36NDtASqAk6ZbnroRNV+zu61txt/qUpayPJ/IrAbI7tAHPGh05o8MXIVJiW/+ekidupmEGOWiGBf1Z4YnHHjQ2ArGeay3M=",
  "userId": "f15b6910-4130-40ec-8651-e536bd6a88b4",
  "tenantId": "acme-corp",
  "newPassword": "MyNewP@ssw0rd123!",
  "confirmPassword": "MyNewP@ssw0rd123!"
}


### Get user's tenants
GET {{baseUrl}}/api/users/{{registeredUserId}}/tenants


### Register Another User (Different email for testing)
POST {{baseUrl}}/api/users/register
Content-Type: application/json

{
  "email": "bob.wilson@example.com",
  "firstName": "Bob",
  "lastName": "Wilson",
  "password": "P@ssw0rd123!",
  "tenantId": "acme-corp"
}


### Register User with Wildcard Tenant Access
POST {{baseUrl}}/api/users/register
Content-Type: application/json

{
  "email": "admin@example.com",
  "firstName": "Admin",
  "lastName": "User",
  "password": "AdminP@ss123!",
  "tenantId": "*"
}


###############################################################################
### USER MANAGEMENT - ACTIVATION FLOW
###############################################################################

### Step 1: User clicks activation link in email (GET request in browser)
# GET {{baseUrl}}/account/activate?token=ACTIVATION_TOKEN&userId=USER_GUID&tenant=acme-corp

### Activate the registered user (Copy token from console logs)
# IMPORTANT: Get the token from application console output (DEV mode only)
@activationToken =  CfDJ8IISH9pSP0dDqu2Sb7sBxQGKcCwAdDuh5O3PuQWgttVALMVAi4RrFi/u5FF/7n/yn8ZhT7noz5IGPuQ/aAfFhzx0U1SYOgzCQS9TplPwVKDeb0bKWL/tEwQFL62g2Lq7+i+BS8h+CPxJx8sqdePUJV/a6xyqLn4kM9VINDiaBlefS9BTCG15ZUuSRVGcqEb4zf6ZYvFnKAxLQ5/mkODLaho=
POST {{baseUrl}}/api/account/activate
Content-Type: application/json

{
  "token": "{{activationToken}}",
  "userId": "{{registeredUserId}}",
  "tenantId": "acme-corp",
  "newPassword": "MyNewP@ssw0rd123!",
  "confirmPassword": "MyNewP@ssw0rd123!"
}


###############################################################################
### USER MANAGEMENT - ACTIVATION FLOW (MVC Form - for browser use)
###############################################################################

### Step 1: User clicks activation link in email (GET request in browser)
# GET {{baseUrl}}/account/activate?token=ACTIVATION_TOKEN&userId=USER_GUID&tenant=acme-corp

### Step 2: User submits activation form with new password (MVC endpoint)
@activationToken2 = YOUR_ACTIVATION_TOKEN
@userId = 00000000-0000-0000-0000-000000000000
POST {{baseUrl}}/account/activate
Content-Type: application/x-www-form-urlencoded

token={{activationToken2}}
&userId={{userId}}
&tenantId=acme-corp
&newPassword=MyNewP@ssw0rd123!
&confirmPassword=MyNewP@ssw0rd123!

# Response: User is activated and automatically signed in


###############################################################################
### USER MANAGEMENT - QUERY OPERATIONS (All endpoints are public)
###############################################################################

### Get User by ID
@userId = 47c60cc4-16f0-4295-a62e-6cb7e167f541
GET {{baseUrl}}/api/users/{{userId}}

# Response includes:
# - id, email, firstName, lastName
# - tenantIds (array of tenant access)
# - roles (array of role names)
# - scopes (array of permission scopes)
# - status (Active, PendingActivation, etc.)


###############################################################################
### USER MANAGEMENT - TENANT ASSIGNMENT (All endpoints are public)
###############################################################################

### Add User to Additional Tenant
POST {{baseUrl}}/api/users/{{userId}}/tenants
Content-Type: application/json

{
  "tenantId": "another-tenant"
}

### Remove User from Tenant
DELETE {{baseUrl}}/api/users/{{userId}}/tenants/another-tenant


###############################################################################
### USER MANAGEMENT - ROLE ASSIGNMENT (All endpoints are public)
###############################################################################

### Assign Role to User
POST {{baseUrl}}/api/users/assign-role
Content-Type: application/json

{
  "userId": "{{userId}}",
  "roleName": "User"
}

# Available roles: TenantAdmin, User, etc.


###############################################################################
### USER MANAGEMENT - SCOPE/PERMISSION ASSIGNMENT (All endpoints are public)
###############################################################################

### Assign Scope to User
POST {{baseUrl}}/api/users/assign-scope
Content-Type: application/json

{
  "userId": "{{userId}}",
  "scopeName": "users.write"
}

# Scopes represent fine-grained permissions
# Examples: users.read, users.write, tenants.manage, clients.manage


###############################################################################
### NOTES:
###############################################################################
#
# Client/Tenant Architecture:
# - Clients no longer store redirect URIs or CORS origins directly
# - Each client is associated with zero or more tenants (via associatedTenantIds)
# - Redirect URIs AND CORS Origins are defined at the Tenant level (allowedReturnUrls and allowedCorsOrigins)
# - IdentityServer dynamically aggregates all redirect URIs and CORS origins from associated tenants
# - To add/modify redirect URIs or CORS origins: update the Tenant's allowedReturnUrls and allowedCorsOrigins properties
# 
# Client Visibility to IdentityServer:
# - A client is VISIBLE to IdentityServer only if:
#   1. It has at least one associated tenant, AND
#   2. The associated tenant(s) have at least one allowedReturnUrl configured
# - Clients without tenants or without returnUrls exist in the database but are invisible to OAuth2/OIDC flows
# - This allows flexible setup: you can create clients first, then tenants, then associate them
#
# Possible Workflows:
# Workflow A (Tenant First):
#   1. Create Tenant with allowedReturnUrls
#   2. Create Client with initialTenantId referencing the tenant
#   3. Client is immediately visible to IdentityServer
#
# Workflow B (Client First):
#   1. Create Client without initialTenantId (invisible to IdentityServer)
#   2. Create Tenant with allowedReturnUrls
#   3. Update Client to associate with tenant (PUT /api/clients/{id})
#   4. Client becomes visible to IdentityServer
#
# Workflow C (Parallel):
#   1. Create Client without tenant
#   2. Create Tenant without clients
#   3. Associate them via Update operations
#   4. Client becomes visible when both conditions are met
#
# Token Storage:
# - Authorization codes, refresh tokens, and user consents are stored in PostgreSQL
# - Tables: PersistedGrants, DeviceCodes, Keys
# - Automatic cleanup of expired tokens every hour
# - Tokens survive application restarts
# - Supports multiple application instances (scale-out)
#
# Onboarding Flow (User-initiated):
# 1. User visits /account/onboarding with tenant parameter
# 2. User fills form and submits
# 3. Notification sent to tenant's external application
# 4. Tenant app validates and calls POST /api/users/register if approved
# 5. User receives activation email with token
# 6. User clicks link and sets password via /account/activate
# 7. User is activated and can log in
#
# Direct Registration Flow (Admin/API):
# 1. Admin calls POST /api/users/register with isPendingActivation=true
# 2. User created with PendingActivation status
# 3. Activation token returned in response
# 4. Admin sends custom activation email with token
# 5. User activates via /account/activate
#
# Tenant Access Control:
# - tenantId="*": Wildcard access to all tenants (super admin)
# - tenantId="specific": Access only to that tenant
# - Users can be added to multiple tenants via /api/users/{id}/tenants
#
# User Status Values (DDD Enumeration Pattern):
# - PendingActivation: Awaiting email activation
# - Active: Can log in
# - Suspended: Account disabled
# - Deleted: Soft deleted
# - IsActive is a computed property (not stored in database)
#
# Authorization:
# - ALL ENDPOINTS ARE PUBLIC (No authentication required)
# - This is for development/testing purposes only
# - In production, add proper authorization to sensitive endpoints
#
###############################################################################
